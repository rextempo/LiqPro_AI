# LiqPro 产品需求文档

## 状态机定义

### 基础状态

- 运行（Running）
- 等待（Waiting）
- 停止（Stopped）

### 扩展状态

- 初始化：Agent创建后资金到位但未建仓
- 部分减仓：风险达到中等阈值触发部分减仓
- 紧急退出：用户触发或严重风险触发全面退出

### 状态转换条件

- Running → Waiting：可用SOL低于0.1
- Waiting → Running：余额超过1 SOL
- Running → 部分减仓：健康评分2.0-2.5持续10分钟
- 任何状态 → 紧急退出：健康评分低于1.5持续5分钟或用户手动触发

## 资金安全要求

### 交易限额

- 单笔上限：用户总资产30%或50 SOL（取小值）
- 日交易限额：不超过总资产70%

### 多重签名要求

- MVP阶段：实现交易前确认和结果验证的双重检查
- 预留多重签名钱包集成接口

## 监控指标定义

### 关键指标阈值

- LP池子健康度变化率：>20%/小时告警
- 交易滑点：>预期1.5倍告警
- 大户LP移除：>10%或主要池子同时移除
- 代币价格波动：30分钟内>15%
- Agent操作空闲时间监控

### 告警级别定义

- 信息：UI显示
- 警告：UI+邮件
- 严重/紧急：UI+邮件+短信/Telegram

## 性能要求

### 并发支持

- MVP阶段：支持500并发用户
- 目标扩展：2000-5000用户

### 交易处理能力

- 常规：10-20 TPS
- 峰值：能应对市场波动时的并发

### 响应时间要求

- 交易延迟：<3秒
- UI响应：<1秒

## 评分系统定义

### 健康度评分构成（100分制）

- 基础性能评分(40%)：
  - 交易量评分(40%)
  - 24h收益率评分(35%)
  - 流动性评分(20%)
  - 费用总量评分(5%)
- 流动性分布评分(25%)
- 费用效率评分(15%)
- 稳定性评分(20%)

### 评分更新要求

- 更新频率：固定5分钟
- 数据存储策略：
  - 5分钟粒度保存48小时
  - 每日UTC 00:00进行汇总

## Agent系统限制

### 资源限制

- 每用户最多5个Agent
- 每Agent最多5个池子LP仓位
- 每小时最多60次交易操作
- 每分钟最多20次API请求
- 同时最多20个进行中操作

### 资源隔离要求

- 独立钱包地址和资金
- 独立存储空间
- 独立执行队列
- 独立风控参数

## 收益计算规则

### 计算公式

- 日收益率 = (当日费用收入/当日平均流动性) × 100%
- 总收益率 = (总收益/初始投资价值) × 100%
- APY = ((1 + 总收益率)^(365/持有天数) - 1) × 100%

### 数据存储策略

- 实时数据：Redis，24小时，5分钟粒度
- 短期数据：MongoDB，7天小时粒度，90天日粒度
- 长期数据：PostgreSQL，365天日粒度，永久周粒度

## 用户权限规范

### 角色划分

- 普通用户：Agent管理权限
- 只读用户：查看权限
- 系统管理员：完全访问权限

### 日志保存要求

- 常规操作：90天
- 关键操作：365天
- 管理员操作：永久保存

## 巡航模块规范

### 自动运行机制

- 执行周期：可配置，默认5分钟
- 触发条件：时间触发或风险阈值触发
- 暂停条件：资金不足或手动暂停
- 恢复机制：自动恢复或手动恢复

### 仓位维护规则

- 最小仓位调整阈值：偏离目标5%以上
- 调整频率限制：每4小时不超过3次
- 单次调整上限：总仓位的10%
- 调整优先级：高风险池优先

### 风控协同策略

- 风险等级与操作映射：
  - 低风险（>4.0）：正常运行
  - 中风险（2.5-4.0）：减少新建仓
  - 高风险（<2.5）：暂停并通知
- 恢复条件：风险指标回升并稳定30分钟以上
- 自动干预权限：可配置，默认允许自动减仓

# 信号系统 - 数据模块功能需求

## 1. 模块目标

数据模块作为信号系统的基础，负责从 Meteora API 获取 DLMM 池子数据，进行初步筛选和预处理，为后续的信号分析提供高质量数据源。

## 2. 核心功能

### 2.1 数据采集

- **数据源**：

  - 主要数据源：Meteora API
  - 备用策略：使用缓存数据（当 API 不可用时）

- **采集内容**：

  - 池子基础信息（地址、名称、代币对等）
  - 流动性数据（储备量、总流动性）
  - 池子性能数据（24小时交易量、24小时费用收入、APR/APY）
  - 费率信息（基础费率、最大费率、协议费率）
  - 当前价格数据

- **更新频率**：
  - 5分钟/次（优化系统性能与数据时效性平衡）

### 2.2 数据筛选

- **筛选规则**：

  - 主要筛选条件：trade_volume_24h ≥ $10,000 AND liquidity ≥ $5,000
  - 排除条件：is_blacklisted = true OR hide = true

- **池子分类**：

  - 基于代币符号的自动分类（通过 mint_x 和 mint_y 地址获取代币信息）
  - 基于流动性和交易量的活跃度分类

- **优先级排序算法**：
  - 归一化处理：将交易量、流动性、费用等指标归一化到0-1范围
  - 计算24小时收益率：fees_24h / liquidity
  - 权重分配：
    - 交易量(40%)：高活跃度池子能持续产生交易费用
    - 24h收益率(35%)：直接反映LP提供者当前的收益状况
    - 流动性(20%)：保证池子有足够深度，减少滑点风险
    - 费用总量(5%)：作为辅助指标，反映池子规模效应
  - 惩罚因子：
    - 费率过高惩罚：当池子基础费率 > 0.5%时，根据公式 `min(0.3, (base_fee_percentage - 0.005) * 20)` 计算惩罚比例，最高惩罚30%
    - 流动性过低惩罚：当池子流动性 < $20,000时，根据公式 `min(0.5, 0.5 - (liquidity / 60000))` 计算惩罚比例，最高惩罚50%

### 2.3 数据存储与管理

- **存储结构**：

  - 实时数据：Redis 缓存（5分钟有效期）
  - 历史数据：每小时快照存储，保留7天

- **数据模型**：

```
PoolData {
  // 直接映射 Meteora API 返回的字段
  address: String,
  name: String,
  mint_x: String,
  mint_y: String,
  reserve_x: String,
  reserve_y: String,
  reserve_x_amount: Number,
  reserve_y_amount: Number,
  bin_step: Number,
  base_fee_percentage: String,
  max_fee_percentage: String,
  protocol_fee_percentage: String,
  liquidity: String,
  fees_24h: Number,
  trade_volume_24h: Number,
  current_price: Number,
  apr: Number,
  apy: Number,
  hide: Boolean,
  is_blacklisted: Boolean,

  // 补充字段
  token_x_info: {
    symbol: String,    // 通过 mint_x 获取
    decimals: Number
  },
  token_y_info: {
    symbol: String,    // 通过 mint_y 获取
    decimals: Number
  },

  // 自定义计算字段
  signal_score: Number,    // 信号系统计算的分数
  daily_yield: Number,     // 24小时收益率(%)
  retrieval_time: Date     // 数据获取时间
}
```

### 2.4 数据预处理

- **数据补充**：

  - 使用 Solana 代币元数据程序查询代币符号和精度信息
  - 计算 USD 价值（如池子中包含非 USD 计价代币）
  - 计算24小时收益率：fees_24h / liquidity \* 100%

- **数据验证**：
  - 检测异常值（如交易量或流动性的突变）
  - 检测数据一致性（如储备金额与总流动性的合理性）

### 2.5 数据监控与质量控制

- **健康检查**：

  - API 连接状态监控（每次请求前）
  - 数据完整性检查（确保所有关键字段存在）

- **异常处理**：
  - 请求失败自动重试（最大 3 次，间隔递增）
  - 异常数据记录与标记
  - 管理员告警机制（连续 3 次失败）

### 2.6 数据输出

- **输出内容**：

  - 筛选后的高质量池子列表（最多100个）
  - 每个池子的完整信息，包括原始数据和计算字段
  - 排序分数及其组成部分（方便调试和优化）
  - 池子类型标签（稳定币对、蓝筹币对等）

- **输出格式**：
  ```javascript
  {
    timestamp: Date,
    pools: [PoolData],
    stats: {
      total_pools: Number,
      filtered_pools: Number,
      avg_daily_yield: Number,
      avg_volume: Number,
      highest_yield_pool: String
    }
  }
  ```

## 3. 风险与考量

1. **数据延迟风险**：Meteora API 可能不稳定或有速率限制，需要实现重试和缓存机制
2. **数据转换风险**：确保数值类型正确转换，处理字符串与数字类型的兼容性
3. **数据时效性问题**：池子状态每分钟都可能发生变化，5分钟更新频率需要在产品验证中确认是否足够
4. **特殊池子处理**：某些新池子或特殊活动池子可能需要额外规则处理

## 4. 验收标准

1. 数据模块能稳定从 Meteora API 获取池子数据，成功率 >99%
2. 筛选算法能准确识别出高质量池子，满足交易量和流动性要求
3. 排序结果符合预期，能将高收益、高流动性、高交易量的池子排在前列
4. 池子数据包含完整的代币信息（符号和精度）
5. 系统能处理 API 异常，在连接失败时使用缓存数据
6. 整个数据模块的端到端处理时间 <5秒

# 信号系统 - 信号模块功能需求

## 1. 模块目标

信号模块是信号系统的核心分析引擎，负责接收数据模块筛选出的高活跃池子数据，通过多维度的量化分析与算法评估，生成高质量投资推荐信号，为Agent系统提供专业级别的投资决策支持。

## 2. 核心功能

### 2.1 增强数据获取

- **基础数据**：
  - 从数据模块接收筛选后的100个高质量池子基础信息
- **增强数据获取**：
  - 使用DLMM SDK获取每个池子的详细链上数据
  - 获取内容包括：
    - 活跃Bin信息（binId, price, pricePerToken）
    - Bins分布数据（周围10-20个bins的xAmount, yAmount）
    - 精确费用信息（baseFee, maxFee, protocolFee, dynamicFee）
    - 流动性分布情况
- **历史数据管理**：
  - 建立池子历史数据存储系统，记录：
    - 每日收盘价格（用于计算波动率）
    - 每日交易量和费用（用于稳定性分析）
    - 每日流动性变化（用于流动性稳定性分析）
  - 实现数据清洗与异常处理
  - 确保至少保留14天的历史数据

### 2.2 优化的多维度评分系统

- **基础性能评分 (40%)**：

  - 交易量评分(40%)：高交易量意味着高活跃度和费用产生能力
  - 24h收益率评分(35%)：最直接反映当前LP投资回报率
  - 流动性评分(20%)：保证池子有足够深度，降低滑点风险
  - 费用总量评分(5%)：作为辅助指标，反映池子规模效应
  - 应用惩罚因子（费率过高、流动性过低）

- **流动性分布评分 (25%)**：

  - 流动性集中度(40%)：价格区间内的流动性分布情况
  - 有效流动性比率(30%)：当前价格±5%范围内的流动性占比
  - 流动性深度(20%)：价格区间内的流动性总量
  - Bin覆盖率(10%)：有流动性的Bins数量的广度

- **费用效率评分 (15%)**：

  - 动态费用适应性(30%)：当前动态费用的合理性
  - 费用收集效率(50%)：实际收集费用与理论可收集费用的比率
  - 费率竞争力(20%)：与同类池子费率的对比优势

- **稳定性评分 (20%)**：
  - 使用历史数据计算：
    - 价格波动评分(40%)：7天价格标准差/均价
    - 收益稳定性(30%)：7天收益率的变异系数
    - 交易量一致性(20%)：交易量日变化率的平均值
    - 流动性稳定性(10%)：流动性日变化率的平均值

### 2.3 历史数据获取与稳定性指标计算

- **历史数据获取方式**：

  1. **内部历史记录**：

     - 系统每日定时（如UTC 00:00）记录所有池子的关键指标
     - 存储格式：
       ```javascript
       {
         date: "2024-03-09",
         pools: [
           {
             address: "ABC123...",
             price: 11.29,
             tvl: 1200000,
             volume_24h: 500000,
             fees_24h: 1500,
             yield_24h: 0.125
           },
           // 其他池子...
         ]
       }
       ```
     - 优势：数据连贯、格式一致、获取快速
     - 劣势：需要系统运行一段时间才能积累足够历史数据

  2. **临时替代方案**（系统初期）：
     - 利用Meteora API获取有限的历史数据
     - 使用区块链浏览器API查询历史交易
     - 基于有限数据进行插值和估算
     - 随着系统运行，逐步过渡到内部历史记录

- **稳定性指标计算**：

  ```javascript
  function calculateStabilityMetrics(poolAddress, historicalData) {
    // 提取该池子的历史数据
    const poolHistory = historicalData
      .map(day => day.pools.find(p => p.address === poolAddress))
      .filter(data => data); // 过滤掉undefined

    // 确保有足够的历史数据
    if (poolHistory.length < 5) {
      return {
        price_volatility: null,
        yield_stability: null,
        volume_consistency: null,
        liquidity_stability: null,
        stability_score: 50, // 默认中等分数
      };
    }

    // 计算价格波动率
    const prices = poolHistory.map(h => h.price);
    const priceVolatility = calculateStandardDeviation(prices) / calculateAverage(prices);

    // 计算收益稳定性
    const yields = poolHistory.map(h => h.yield_24h);
    const yieldVariability = calculateCoefficientOfVariation(yields);

    // 计算交易量一致性
    const volumes = poolHistory.map(h => h.volume_24h);
    const volumeVariability = calculateDailyChangeRate(volumes);

    // 计算流动性稳定性
    const liquidity = poolHistory.map(h => h.tvl);
    const liquidityVariability = calculateDailyChangeRate(liquidity);

    // 转换为评分（波动性越低，分数越高）
    const priceVolatilityScore = mapToScore(priceVolatility, 0.3, 0, 100, 0);
    const yieldStabilityScore = mapToScore(yieldVariability, 0.5, 0, 100, 0);
    const volumeConsistencyScore = mapToScore(volumeVariability, 0.4, 0, 100, 0);
    const liquidityStabilityScore = mapToScore(liquidityVariability, 0.3, 0, 100, 0);

    // 加权计算总稳定性分数
    const stabilityScore =
      priceVolatilityScore * 0.4 +
      yieldStabilityScore * 0.3 +
      volumeConsistencyScore * 0.2 +
      liquidityStabilityScore * 0.1;

    return {
      price_volatility: priceVolatility,
      yield_stability: yieldVariability,
      volume_consistency: volumeVariability,
      liquidity_stability: liquidityVariability,
      price_volatility_score: priceVolatilityScore,
      yield_stability_score: yieldStabilityScore,
      volume_consistency_score: volumeConsistencyScore,
      liquidity_stability_score: liquidityStabilityScore,
      stability_score: stabilityScore,
    };
  }
  ```

### 2.4 综合风险评分计算

- **风险评分组成**：
  - 价格风险(40%)：基于历史波动率
  - 流动性风险(30%)：基于流动性深度和交易量比率
  - 流动性分布风险(20%)：过度集中或过度分散的风险
  - 池子年龄风险(10%)：较新池子风险较高
- **风险数据获取与计算**：

  ```javascript
  function calculateRiskScore(pool, enhancedData, historicalData) {
    // 计算价格风险（基于历史波动率）
    const stabilityMetrics = calculateStabilityMetrics(pool.address, historicalData);
    const priceRisk = stabilityMetrics.price_volatility
      ? 100 - stabilityMetrics.price_volatility_score
      : 50;

    // 计算流动性风险（流动性与交易量比率）
    const liquidityToVolumeRatio = parseFloat(pool.liquidity) / (pool.trade_volume_24h || 1);
    // 理想比率约为5-10，过高表示流动性使用效率低，过低表示流动性不足
    const liquidityRiskScore =
      liquidityToVolumeRatio < 3
        ? 100 - mapToScore(liquidityToVolumeRatio, 0, 3, 0, 100) // 流动性不足风险
        : liquidityToVolumeRatio > 20
          ? mapToScore(liquidityToVolumeRatio, 20, 100, 30, 70) // 流动性过剩风险
          : 30; // 理想范围

    // 计算流动性分布风险（基于流动性分布）
    let distributionRisk = 50; // 默认中等风险
    if (enhancedData && enhancedData.bins) {
      const distribution = analyzeLiquidityDistribution(enhancedData.bins);

      // 过度集中或过度分散都会增加风险
      if (distribution.concentration > 0.8) {
        // 过度集中风险
        distributionRisk = 70 + (distribution.concentration - 0.8) * 150;
      } else if (distribution.concentration < 0.3) {
        // 过度分散风险
        distributionRisk = 70 + (0.3 - distribution.concentration) * 150;
      } else {
        // 适中分布，较低风险
        distributionRisk = 30 + Math.abs(distribution.concentration - 0.5) * 80;
      }
    }

    // 计算池子年龄风险（如果有创建时间数据）
    const ageInDays = pool.creation_time
      ? (Date.now() - new Date(pool.creation_time).getTime()) / (1000 * 60 * 60 * 24)
      : 30; // 默认假设30天

    const ageRisk =
      ageInDays < 7
        ? 90 // 新池子高风险
        : ageInDays < 30
          ? 70 - (ageInDays - 7) * (40 / 23) // 7-30天，风险从70降到30
          : 30; // 老池子稳定风险

    // 加权计算总风险分数
    return {
      price_risk: priceRisk,
      liquidity_risk: liquidityRiskScore,
      distribution_risk: distributionRisk,
      age_risk: ageRisk,
      overall_risk_score:
        priceRisk * 0.4 + liquidityRiskScore * 0.3 + distributionRisk * 0.2 + ageRisk * 0.1,
    };
  }
  ```

### 2.5 最终综合评分计算

```javascript
function calculateFinalScore(pool, enhancedData, historicalData) {
  // 1. 基础性能评分 (40%)
  const basePerformanceScore = calculateBasePerformanceScore(pool);

  // 2. 流动性分布评分 (25%)
  const liquidityDistributionScore =
    enhancedData && enhancedData.bins
      ? calculateLiquidityDistributionScore(enhancedData.bins, pool.current_price)
      : 50; // 默认中等分数

  // 3. 费用效率评分 (15%)
  const feeEfficiencyScore =
    enhancedData && enhancedData.fee_info
      ? calculateFeeEfficiencyScore(pool, enhancedData.fee_info)
      : 50; // 默认中等分数

  // 4. 稳定性评分 (20%)
  const stabilityMetrics = calculateStabilityMetrics(pool.address, historicalData);
  const stabilityScore = stabilityMetrics.stability_score || 50;

  // 5. 计算综合风险评分（用于风险调整）
  const riskMetrics = calculateRiskScore(pool, enhancedData, historicalData);
  const riskScore = riskMetrics.overall_risk_score;

  // 6. 计算加权综合评分
  const weightedScore =
    basePerformanceScore * 0.4 +
    liquidityDistributionScore * 0.25 +
    feeEfficiencyScore * 0.15 +
    stabilityScore * 0.2;

  // 7. 风险调整
  // 风险越高，评分折扣越大，但保留至少60%
  const riskAdjustmentFactor = Math.max(0.6, 1 - (riskScore / 100) * 0.4);
  const finalScore = weightedScore * riskAdjustmentFactor;

  // 8. 返回完整评分明细
  return {
    base_performance_score: basePerformanceScore,
    liquidity_distribution_score: liquidityDistributionScore,
    fee_efficiency_score: feeEfficiencyScore,
    stability_score: stabilityScore,
    risk_score: riskScore,
    weighted_score: weightedScore,
    risk_adjustment_factor: riskAdjustmentFactor,
    final_score: finalScore,
  };
}
```

### 2.6 池子选择与输出格式化

- **多样性优化选择**：

  - 利用池子代币地址识别相关性
  - 确保所选T1池子不全部集中于相同代币或相同类型

- **标准输出结构**：
  ```json
  {
    "analysis_timestamp": "2024-03-09T12:00:00Z",
    "market_condition": {
      "trend": "上升",
      "volatility": "中等"
    },
    "t1_pools": [
      {
        "pool_address": "ABC123...",
        "name": "SOL-USDC",
        "token_pair": {
          "token_x": {
            "symbol": "SOL",
            "address": "So11111111111111111111111111111111111111112"
          },
          "token_y": {
            "symbol": "USDC",
            "address": "EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v"
          }
        },
        "metrics": {
          "liquidity": 1200000,
          "volume_24h": 500000,
          "fees_24h": 1500,
          "daily_yield": 0.125,
          "active_bin": {
            "binId": 486,
            "price": "11.29031382",
            "pricePerToken": "11.29031382"
          }
        },
        "liquidity_distribution": {
          "effective_liquidity_ratio": 0.85,
          "distribution_type": "concentrated"
        },
        "fee_info": {
          "base_fee": "0.1%",
          "max_fee": "10%",
          "current_dynamic_fee": "0.15%"
        },
        "stability_metrics": {
          "price_volatility": 0.05,
          "yield_stability": 0.12,
          "stability_score": 78
        },
        "risk_metrics": {
          "price_risk": 22,
          "liquidity_risk": 25,
          "overall_risk": 24
        },
        "scores": {
          "base_performance_score": 85,
          "liquidity_distribution_score": 87,
          "fee_efficiency_score": 92,
          "stability_score": 78,
          "risk_score": 24,
          "final_score": 88.5
        },
        "recommendation": {
          "position_size": "高",
          "price_range": {
            "min": 10.73,
            "max": 11.85,
            "current": 11.29,
            "optimal_range_percentage": 5
          },
          "bin_distribution": "集中式",
          "bin_step": 50
        }
      }
      // 其他T1池子...
    ],
    "t2_pools": [
      // 备选池子信息...
    ]
  }
  ```

## 3. 风险与考量

1. **历史数据积累挑战**：系统初期可能缺乏足够历史数据进行稳定性评分
2. **RPC可靠性风险**：获取链上详细数据依赖可靠的RPC节点
3. **计算资源需求**：复杂的多维度评分需要适当计算资源
4. **评分参数调优**：需要根据实际市场反馈不断优化评分权重
5. **异常数据处理**：需要处理池子数据异常或缺失情况

## 4. 验收标准

1. 信号模块能稳定获取并分析链上增强数据
2. 基于流动性分布的价格区间推荐准确率超过80%
3. 推荐的T1池子平均收益率应优于市场平均水平的25%以上
4. 推荐池子的风险控制有效，最大回撤不超过市场平均的75%
5. 系统处理100个池子的完整分析时间不超过30秒
6. 多样性优化算法能有效避免推荐高度相关的池子
7. 自适应优化机制能根据历史表现逐步提高推荐准确率

# 信号系统 - 打分模块和输出模块功能需求

## 1. 打分模块功能需求

### 1.1 模块目标

打分模块是信号系统的核心评估单元，负责对信号模块分析后的池子进行最终评分、排序和筛选，生成最终的T1、T2、T3级别推荐池子，为Agent系统提供明确的投资决策支持。

### 1.2 数据来源

- **基础池子数据**：从数据模块获取的基本信息（流动性、交易量、费用等）
- **增强链上数据**：信号模块通过DLMM SDK获取的链上详细数据
- **系统内部历史数据**：系统自己记录的历史数据（每天快照一次）
- **实时交易监控数据**：通过Solana RPC订阅的池子交易数据

### 1.3 评分整合流程

- **多维度评分整合**：

  - 基础性能评分(40%)：衡量池子的基础表现（交易量、收益率等）
  - 流动性分布评分(25%)：评估流动性分布的合理性和有效性
  - 费用效率评分(15%)：评估费用设置的合理性和费用收集效率
  - 稳定性评分(20%)：评估池子在历史表现上的稳定程度

- **风险调整**：
  - 应用风险调整因子调整加权评分
  - 风险调整系数公式：max(0.6, 1 - (riskScore / 100 \* 0.4))
  - 风险分数越高，评分扣减幅度越大，最多降低40%

### 1.4 大额LP交易监控

- **实时交易监控**：

  - 利用Solana RPC订阅机制监控池子地址的交易
  - 识别LP添加/移除操作（解析交易指令）
  - 计算交易金额并与阈值比较

- **大额交易定义**：
  - 相对标准：单笔交易流动性 > 池子总流动性的5%
  - 绝对标准：不同规模池子设置不同阈值（大池>$50,000，中等池>$20,000，小池>$10,000）

### 1.5 大额交易分析

- **评分影响计算**：

  - 流入型大额LP（添加）：根据净流入占比适度提高池子评分（最高+3分）
  - 流出型大额LP（移除）：根据净流出占比适度降低池子评分（最高-5分）
  - 连续大额移除额外惩罚：6小时内连续移除施加额外扣分

- **大户活动分析**：

  - 维护已知大户地址列表，分析其活动模式
  - 大户净流入为正面信号，提供加分奖励
  - 分析大户交易量占比，占比越高奖励越高

- **交易地址模式分析**：

  - 识别频繁交易地址和高交易量地址
  - 分析地址的添加/移除行为模式
  - 识别特定市场行为（散户恐慌、大户积累、大户分配等）

- **评分整合**：
  - 将大额交易分析结果整合到总体评分系统
  - 调整原始加权评分和风险评分
  - 重新计算风险调整后的最终评分

### 1.6 风险评估与调整

- **风险评分计算**：

  - 价格风险(35%)：基于可获取的历史价格数据计算波动率
  - 流动性风险(25%)：基于流动性深度和交易量比率
  - 流动性分布风险(20%)：流动性过度集中或过度分散的风险
  - 大额交易风险(20%)：基于实时交易监控数据评估资金流动风险

- **风险等级划分**：
  - 1级风险：风险分数 < 20，极低风险
  - 2级风险：风险分数 20-40，低风险
  - 3级风险：风险分数 40-60，中等风险
  - 4级风险：风险分数 60-80，高风险
  - 5级风险：风险分数 > 80，极高风险

### 1.7 池子分级系统

- **三级分类标准**：

  - **T1级别**（顶级推荐）：
    - 最终评分 > 85分
    - 风险等级 ≤ 3
    - 相互之间代币多样性得分 > 0.7
    - 数量：通常为3个
  - **T2级别**（次优推荐）：
    - 最终评分 75-85分，或
    - 风险等级 = 4但评分 > 80分
    - 数量：通常为5个
  - **T3级别**（监控推荐）：
    - 最终评分 65-75分，或
    - 风险等级 < 5但有特殊增长潜力
    - 数量：通常为7个

- **多样性保证**：
  - 确保T1级别池子之间的代币不完全重叠
  - 当多个池子包含相同代币对时，根据评分和多样性需求降低选择优先级
  - 为具有不同代币组合的池子提供多样性加分

### 1.8 投资建议生成

- **价格区间计算**：

  - 根据流动性分布和历史价格波动分析最优价格区间
  - 区间范围基于池子的波动特性动态调整：
    - 稳定币对：±0.5%-2%
    - 中等波动币对：±5%-10%
    - 高波动币对：±10%-20%
  - 确保区间与实际Bin边界对齐

- **仓位建议生成**：

  - 高：评分 > 85且风险等级 ≤ 2
  - 中：评分 65-85或风险等级 = 3
  - 低：评分 < 65或风险等级 ≥ 4

- **Bin分布策略**：
  - 集中式：80%流动性集中在中心价格区间
  - 平衡式：流动性均匀分布在整个价格区间
  - 梯度式：从中心向边缘逐渐减少流动性分配

## 2. 输出模块功能需求

### 2.1 标准化输出结构

- **完整输出结构**：

  ```json
  {
    "analysis_timestamp": "2024-03-09T12:00:00Z",
    "market_condition": {
      "trend": "上升",
      "volatility": "中等",
      "liquidity_climate": "充裕"
    },
    "t1_pools": [ ... ],
    "t2_pools": [ ... ],
    "t3_pools": [ ... ],
    "monitoring_summary": { ... }
  }
  ```

- **池子详细信息结构**：

  ```json
  {
    "pool_address": "ABC123...",
    "name": "SOL-USDC",
    "token_pair": {
      "token_x": { "symbol": "SOL", "address": "So11111..." },
      "token_y": { "symbol": "USDC", "address": "EPjF..." }
    },
    "metrics": {
      "liquidity": 1200000,
      "volume_24h": 500000,
      "fees_24h": 1500,
      "daily_yield": 0.125,
      "active_bin": {
        "binId": 486,
        "price": "11.29031382",
        "pricePerToken": "11.29031382"
      }
    },
    "liquidity_distribution": {
      "effective_liquidity_ratio": 0.85,
      "distribution_type": "concentrated"
    },
    "large_transactions": {
      "recent_large_adds": [
        {
          "amount": 125000,
          "percentage": 10.4,
          "timestamp": "2024-03-09T10:15:22Z"
        }
      ],
      "recent_large_removes": [],
      "24h_net_large_flow": 125000,
      "significance": "positive"
    },
    "risk_metrics": {
      "price_risk": 22,
      "liquidity_risk": 25,
      "distribution_risk": 20,
      "large_transaction_risk": 15,
      "overall_risk": 22,
      "risk_level": 2
    },
    "scores": {
      "base_performance_score": 85,
      "liquidity_distribution_score": 87,
      "fee_efficiency_score": 92,
      "stability_score": 78,
      "weighted_score": 85.2,
      "risk_adjustment_factor": 0.912,
      "final_score": 87.8
    },
    "recommendation": {
      "position_size": "高",
      "price_range": {
        "min": 10.73,
        "max": 11.85,
        "current": 11.29,
        "optimal_range_percentage": 5
      },
      "bin_distribution": "集中式",
      "bin_step": 50
    },
    "transaction_analysis": {
      "score_adjustment": 1.5,
      "address_patterns": {
        "pattern": "whale_accumulation",
        "significant_addresses": [
          {
            "address": "7NPtj...",
            "frequency": 3,
            "total_volume": 200000,
            "is_known_whale": true
          }
        ]
      }
    }
  }
  ```

- **数据完整性要求**：
  - 所有必要字段完整且格式正确
  - 数值型数据保持适当精度（价格和百分比保留5位小数，金额保留2位小数）
  - 可选字段在数据缺失时提供合理默认值

### 2.2 大额交易报告

- **大额交易输出格式**：

  - 最近大额添加交易列表（时间、金额、占比）
  - 最近大额移除交易列表（时间、金额、占比）
  - 24小时净流量金额和意义（正向、中性、负向）
  - 交易地址模式分析结果和重要地址列表

- **大额交易影响评估**：

  - 正向影响：24小时内净流入 > 池子总流动性的5%
  - 负向影响：24小时内净流出 > 池子总流动性的5%
  - 中性影响：大额流入流出基本平衡

- **流动性趋势分析**：
  - 大额交易历史趋势分析（7天数据）
  - "智能资金"流动模式分析（已知大户地址）
  - 异常交易模式检测（如短时间内的大量小额移除）

### 2.3 监控系统集成

- **统一监控频率**：

  - 所有T1、T2、T3池子使用5分钟/次的统一监控频率

- **监控维度设置**：

  - 常规指标监控：价格、交易量、流动性、收益率
  - 大额交易监控：实时检测并记录大额LP操作
  - 指标偏差监控：检测关键指标的异常变化

- **警报阈值设置**：

  - 价格变动警报阈值：±7%
  - 流动性变动警报阈值：-20%
  - 收益率变动警报阈值：±30%
  - 大额LP移除警报：单笔移除 > 10%或24小时累计移除 > 20%

- **监控状态输出**：
  ```json
  "monitoring_status": {
    "active_monitors": 15,
    "last_update": "2024-03-09T12:05:00Z",
    "alerts": [
      {
        "pool": "JTO-USDC",
        "type": "price_change",
        "threshold": "7%",
        "actual": "8.2%",
        "timestamp": "2024-03-09T11:55:00Z",
        "severity": "medium"
      },
      {
        "pool": "BONK-SOL",
        "type": "large_remove",
        "threshold": "10%",
        "actual": "12.5%",
        "timestamp": "2024-03-09T11:30:00Z",
        "severity": "high"
      }
    ]
  }
  ```

### 2.4 历史表现追踪

- **历史数据记录**：

  - 保存每次分析的完整结果
  - 记录T1、T2、T3池子的组成变化
  - 追踪每个池子的评分变化趋势
  - 记录大额交易历史和影响

- **表现评估指标**：

  - 推荐准确率：T1池子实际收益优于非T1池子的百分比
  - 风险控制有效性：T1池子回撤与预期风险的符合度
  - 多样性有效性：推荐池子组合在不同市场环境下的表现

- **持续优化机制**：
  - 基于历史表现自动调整评分权重
  - 识别历史表现与评分不符的异常池子
  - 生成评分模型改进建议

### 2.5 数据可视化支持

- **提供专用可视化数据结构**：

  - 雷达图数据：各维度评分标准化
  - 散点图数据：收益-风险分布
  - 热图数据：池子相关性矩阵
  - 柱状图数据：各维度评分对比

- **大额交易可视化数据**：
  - 大额交易时间线数据
  - 流入/流出量对比数据
  - 流动性变化趋势数据

## 3. 风险与考量

1. **RPC可靠性风险**：大额交易监控依赖于Solana RPC节点的稳定性和性能
2. **交易解析复杂性**：不同类型的LP操作可能有不同的交易结构，需要全面解析
3. **计算资源需求**：实时监控多个池子的交易可能需要较多计算和网络资源
4. **历史数据积累**：系统初期可能缺乏足够的内部历史数据进行完整分析
5. **评分平衡**：确保评分体系平衡收益潜力与风险控制，不过度偏向任一方面
6. **大户地址识别**：确定"大户"或"智能资金"地址需要持续的市场研究和数据积累
7. **市场动态适应**：市场条件变化迅速，评分和监控系统需要适应不同市场环境

## 4. 验收标准

### 4.1 打分模块验收标准

1. **评分准确性**：

   - 评分算法能区分高质量和低质量池子，与人工判断一致率>85%
   - 池子评分排序与实际收益率趋势一致性>80%
   - 风险分级准确率>90%，能正确识别高风险池子

2. **大额交易分析**：

   - 大额交易监控能正确识别并记录>95%的大额LP操作
   - 大额交易影响评估与实际池子表现相关性>75%
   - 交易地址模式分析能有效识别市场行为模式

3. **池子分级**：
   - T1级别池子平均收益率优于T2/T3池子
   - 多样性控制有效，T1池子的代币重叠度合理
   - 池子推荐符合用户风险偏好，投资建议适用性>90%

### 4.2 输出模块验收标准

1. **数据格式**：

   - 输出格式完全符合Agent系统需求，解析成功率100%
   - 所有必要字段完整且格式正确，错误率<0.1%
   - 大额交易报告数据完整准确，与链上数据一致性>98%

2. **监控功能**：

   - 所有T1/T2/T3池子成功加入监控系统，覆盖率100%
   - 监控警报能及时准确发现异常情况，漏报率<5%，误报率<10%
   - 警报严重性分级准确，高严重性警报准确率>95%

3. **历史追踪**：
   - 历史数据完整性>99%，无数据丢失或损坏
   - 表现评估指标计算准确，反映实际情况
   - 决策支持数据完整且有用，能促进系统迭代优化

# 信号系统 - 运行模块功能需求

## 1. 模块目标

运行模块是信号系统的核心协调单元，负责管理整个信号系统的持续运作，确保数据采集、分析和存储的定时执行，并协调各模块间的数据流转，为系统提供可靠的历史数据积累和运行保障。

## 2. 核心功能

### 2.1 定时任务调度

- **任务调度机制**：

  - 基于cron表达式的精确调度系统
  - 每5分钟触发一次完整的信号系统运行周期
  - 任务优先级管理，确保核心功能优先执行
  - 动态调整执行频率（特殊情况如市场波动加大时可缩短间隔）

- **主要定时任务**：

  - 数据模块采集任务：每5分钟执行一次
  - 信号模块分析任务：每5分钟执行一次
  - 打分模块评估任务：每5分钟执行一次
  - 大额交易监控任务：实时运行，结果每5分钟汇总一次
  - 历史数据备份任务：每天执行一次（UTC 00:00）

- **任务依赖管理**：
  - 建立清晰的任务执行依赖链
  - 数据模块 → 信号模块 → 打分模块 → 输出模块
  - 确保上游任务完成后才触发下游任务

### 2.2 数据持久化存储

- **数据存储架构**：

  - 实时数据层：Redis缓存，保存最新分析结果
  - 短期数据层：MongoDB，保存近期（30天内）详细数据
  - 长期数据层：PostgreSQL，保存历史归档数据（压缩存储）
  - 对象存储层：S3兼容存储，保存原始数据快照和大型数据集

- **存储内容结构**：

  - 原始池子数据：Meteora API返回的原始数据
  - 增强分析数据：通过DLMM SDK获取的链上详细数据
  - 评分结果数据：各维度评分和最终推荐结果
  - 大额交易数据：监控到的LP添加/移除记录
  - 系统运行日志：各模块的运行状态和性能指标

- **数据版本管理**：
  - 每次分析结果带时间戳和版本标识
  - 支持数据点到点的历史对比
  - 提供数据演变趋势分析能力

### 2.3 系统监控与健康检查

- **健康检查机制**：

  - 对各模块的健康状态进行定期检查
  - 检查运行耗时、内存使用、API连接状态等指标
  - 设置关键指标的阈值告警
  - 自动恢复机制，重启失败的模块

- **运行指标监控**：

  - CPU/内存使用率监控
  - 网络带宽和API调用次数监控
  - 任务执行时间监控
  - 数据存储容量监控

- **系统日志管理**：
  - 分级日志记录（错误、警告、信息、调试）
  - 关键操作的详细日志
  - 异常情况的错误堆栈记录
  - 日志自动轮转和归档

### 2.4 容错与失败恢复

- **错误处理机制**：

  - 细粒度的错误捕获和分类
  - 任务失败后的自动重试（指数退避策略）
  - 核心功能的降级服务方案
  - 灾难恢复机制

- **数据一致性保障**：

  - 事务性操作确保数据ACID属性
  - 防止部分失败导致的数据不一致
  - 数据校验和完整性检查
  - 记录数据来源与处理链路

- **备用方案**：
  - RPC节点故障时的自动切换
  - 数据源API故障时的缓存数据使用
  - 关键模块的冗余实现
  - 紧急手动干预接口

### 2.5 数据管理与查询接口

- **历史数据查询API**：

  - 按池子地址查询历史数据
  - 按时间范围查询历史评分
  - 按评分等级查询历史推荐池子
  - 复合条件的高级查询

- **数据导出功能**：

  - 支持多种格式导出（JSON、CSV）
  - 定制化数据报表生成
  - 定期数据摘要自动生成
  - API访问密钥管理

- **数据清理策略**：
  - 自动数据老化处理
  - 不同粒度的数据保留策略（小时粒度保留7天，日粒度保留90天，周粒度保留1年）
  - 数据压缩和归档
  - 数据裁剪和采样

## 3. 系统架构设计

### 3.1 核心组件

- **调度器**：

  - 基于Quartz或类似系统的任务调度引擎
  - 分布式锁机制保证集群环境下的任务唯一执行
  - 任务执行状态追踪和历史记录
  - 动态任务参数配置

- **状态管理器**：

  - 管理各模块的运行状态
  - 跟踪任务执行进度和结果
  - 记录系统健康状态
  - 提供实时状态查询API

- **数据连接管理**：

  - 管理与各数据库的连接池
  - 处理数据库连接异常和重试
  - 优化数据库查询性能
  - 实现数据分片和备份策略

- **指标收集器**：
  - 收集系统运行指标
  - 计算关键业务指标
  - 生成性能报告
  - 提供指标查询接口

### 3.2 部署架构

- **单体架构**（初期）：

  - 所有模块集成在一个服务中
  - 简化部署和管理
  - 资源共享，降低复杂性
  - 适用于中小规模系统

- **集群架构**（扩展期）：
  - 核心模块独立部署
  - 使用消息队列解耦组件
  - 实现水平扩展能力
  - 支持高可用配置

### 3.3 资源需求

- **服务器配置**：

  - CPU：4核8线程及以上
  - 内存：16GB及以上
  - 存储：SSD 500GB及以上
  - 网络：千兆以太网，低延迟连接

- **软件依赖**：
  - 操作系统：Linux（推荐Ubuntu 20.04或更高版本）
  - 数据库：Redis 6.0+，MongoDB 4.4+，PostgreSQL 13+
  - 运行环境：Node.js 16+或Java 11+
  - 监控工具：Prometheus + Grafana

## 4. 运行流程

### 4.1 主循环流程

1. **启动阶段**：

   - 加载系统配置
   - 初始化数据库连接
   - 注册任务调度
   - 启动健康检查

2. **运行阶段**（每5分钟一次）：

   - 触发数据模块采集池子数据
   - 等待数据模块完成，获取采集结果
   - 触发信号模块进行增强分析
   - 等待信号模块完成，获取分析结果
   - 触发打分模块进行评分和排序
   - 等待打分模块完成，获取排序结果
   - 触发输出模块生成最终输出
   - 持久化所有数据和结果
   - 更新系统状态和指标

3. **监控阶段**（实时）：
   - 监控系统健康状态
   - 检查任务执行时间是否超时
   - 检查资源使用是否超限
   - 触发必要的告警和恢复操作

### 4.2 数据持久化流程

1. **实时数据存储**：

   - 每5分钟运行周期结束后立即存储
   - 保存完整的输入数据和输出结果
   - 添加时间戳和版本标记
   - 设置TTL防止无限增长

2. **历史数据管理**：

   - 每天凌晨进行数据汇总和压缩
   - 将过期数据从实时层移至历史层
   - 对长期存储的数据进行优化
   - 执行数据完整性检查

3. **系统状态快照**：
   - 定期（如每小时）生成系统状态快照
   - 包含所有模块的运行状态
   - 记录关键性能指标
   - 支持系统状态回溯分析

### 4.3 故障恢复流程

1. **故障检测**：

   - 持续监控各模块的健康状态
   - 检测超时任务和失败任务
   - 识别异常资源使用
   - 验证数据一致性

2. **恢复策略**：

   - 轻微故障：自动重试最多3次
   - 中度故障：重启相关服务
   - 严重故障：切换到备用系统并告警
   - 灾难性故障：从最近的备份恢复

3. **降级运行**：
   - 定义核心功能和非核心功能
   - 故障时优先保证核心功能运行
   - 提供最低限度的服务能力
   - 实现平滑的服务恢复

## 5. 系统监控与管理

### 5.1 管理界面

- **运行状态面板**：

  - 显示各模块的运行状态
  - 任务执行统计和历史记录
  - 系统资源使用情况
  - 关键业务指标展示

- **数据浏览界面**：

  - 历史数据查询和过滤
  - 数据趋势图表
  - 池子评分对比
  - 推荐结果历史

- **配置管理界面**：
  - 系统参数配置
  - 任务调度设置
  - 告警阈值调整
  - 用户权限管理

### 5.2 告警系统

- **告警级别**：

  - 信息：系统正常事件通知
  - 警告：需要关注但不影响系统运行
  - 错误：影响部分功能的故障
  - 严重：影响核心功能的故障

- **告警渠道**：

  - 电子邮件通知
  - Slack/Discord集成
  - 短信通知（严重告警）
  - 告警日志存档

- **告警触发规则**：
  - 任务执行超时（>4分钟）
  - 连续任务失败（>3次）
  - 资源使用超限（CPU>80%，内存>85%）
  - 数据异常（如池子数量突变>30%）

### 5.3 性能优化

- **任务并行化**：

  - 数据获取任务并行执行
  - 独立池子的分析可并行处理
  - 使用工作池管理并行任务
  - 控制并发度防止资源过载

- **数据缓存策略**：

  - 频繁访问数据的内存缓存
  - 池子基本信息的本地缓存
  - 分析结果的短期缓存
  - 缓存失效策略优化

- **查询优化**：
  - 建立适当的索引
  - 优化查询语句
  - 实现数据分区策略
  - 利用数据库查询计划分析

## 6. 风险与考量

1. **时间敏感性**：5分钟的执行周期要求各模块处理速度快，需优化性能
2. **数据增长**：长期运行会积累大量历史数据，需有效的数据管理策略
3. **资源消耗**：频繁的数据处理和存储可能导致高资源消耗，需监控和优化
4. **外部依赖**：对Meteora API和Solana RPC的依赖可能带来稳定性风险
5. **系统复杂性**：多模块协同工作增加了系统复杂性，需谨慎管理状态和交互

## 7. 验收标准

1. **可靠性**：

   - 系统能够持续稳定运行>30天，无人工干预
   - 任务调度成功率>99.9%
   - 所有模块之间的数据传递成功率100%
   - 故障自动恢复成功率>95%

2. **性能**：

   - 完整运行周期处理时间<4分钟（留出1分钟缓冲）
   - 数据查询响应时间<500ms
   - CPU平均使用率<50%
   - 内存使用率稳定，无泄漏

3. **数据质量**：

   - 所有关键数据点100%被记录
   - 数据存储的完整性和一致性校验通过
   - 历史数据可追溯性100%
   - 数据查询准确率100%

4. **可用性**：
   - 系统总体可用性>99.5%
   - 核心功能可用性>99.9%
   - 平均故障恢复时间<5分钟
   - 零数据丢失

# Agent系统-Agent管理模块

## 1. 概述

Agent管理模块是基于Solana的AI驱动自动化LP投资系统的核心用户界面，允许用户创建、监控和管理自动投资Agent。该模块帮助普通用户轻松参与DeFi LP投资，获得被动收益。

## 2. 用户核心旅程

1. 连接钱包
2. 创建Agent并注入资金
3. 查看Agent表现和收益
4. 调整设置或提取收益
5. 必要时关闭Agent

## 3. 核心功能设计

### 3.1 Dashboard主界面 (优先级：高)

**精简概览区域**：

- 总资产价值(USD)
- 总收益数据：24小时/7天收益率
- Agent状态一览：运行/暂停数量
- 创建新Agent按钮

**简化Agent列表**：

- 核心数据列：名称、状态、资产规模、24h收益率、操作
- 基础排序：按收益率或创建时间
- 分页控件：每页显示10个Agent

**核心图表**：

- 收益趋势图（仅提供7天视图）

### 3.2 Agent创建流程 (优先级：高)

**简化创建流程**：

1. **基础设置**：

   - Agent名称（可使用系统默认名称）
   - 生成钱包地址并展示

2. **资金注入**：

   - 输入注入金额(仅接受SOL)
   - 显示建议最低金额
   - 执行交易

3. **风险设置**：

   - 简单的风险偏好选择（低/中/高）
   - 启动Agent

4. **私钥导出** (优先级：高)：
   - 加密私钥导出选项（密码保护）
   - 生成包含加密私钥的文件下载
   - 提供安全保管提示和风险警告
   - 确认对话框确保用户理解私钥重要性

### 3.3 Agent详情页面 (优先级：高)

**核心信息区**：

- 基本信息(名称、钱包地址)
- 当前状态(运行/暂停)
- 资产总值和收益数据
- 控制按钮(暂停/恢复、紧急停止)

**池子信息区**：

- 当前活跃池子列表(最多显示5个)
- 池子基本数据(代币对、收益率)

**简化收益区域**：

- 基础收益图表(7天数据)
- 当前收益率数据

**交易记录**：

- 最近10笔交易记录
- 基本信息(时间、类型、金额)

**Agent智能日志** (优先级：高)：

- 实时滚动的操作日志，类似科幻电影中的AI界面
- 以第一人称视角展示Agent执行的行动
- 包含动态文本效果（打字效果、脉冲光效）
- 关键决策前显示"思考"过程，例如：
  - "分析中... 检测到SOL-USDC池子收益率上升趋势，计算最优LP位置..."
  - "警告：JTO-BONK池子波动率增加42%，评估风险中..."
  - "执行决策：分配35% SOL至BLUR-USDC池，预期收益率8.7%"
- 定期显示市场分析和状态报告
- 在执行交易时展示"代码式"操作日志
- 使用科技术语和视觉设计强化智能体感知

### 3.4 Agent设置 (优先级：中)

**精简设置项**：

- Agent名称编辑
- 风险偏好调整(低/中/高)
- 最大池子数量限制

### 3.5 资金管理功能 (优先级：高)

**核心资金操作**：

- 资金注入功能
- 收益/本金提取功能(全部/部分)
- 紧急提款(一键清仓)：触发Agent强制解除所有LP并将资产swap回SOL

**紧急关停机制**：

- 显著的紧急关停按钮
- 关停确认对话框，明确说明后果
- 关停流程状态实时展示：
  1. 初始化关停 → 暂停新操作
  2. 解除LP进行中 → 显示进度条
  3. 资产转换为SOL → 显示swap状态
  4. 关停完成 → 展示最终SOL余额
- 关停操作日志特殊高亮显示
- 关停期间禁用其他操作按钮

### 3.6 通知功能 (优先级：低)

**简化通知**：

- 仅保留关键事件通知：交易完成、清仓提醒、紧急警报
- 仅在Dashboard内显示通知，无需外部推送

## 4. 技术实现考量

- 数据更新：Agent运行日志实时更新，其他数据每5分钟更新一次
- 只支持桌面和平板设备，暂不优化移动设备
- 实现基础的安全措施：钱包加密和操作确认
- Agent日志使用预设模板和随机变量生成自然语言描述
- 私钥使用AES-256加密后再导出
- 关停机制实现高优先级处理，确保及时响应

## 5. 用户界面设计

- 遵循简单明了的设计原则
- 使用预设的UI模板和组件
- Agent日志区域采用科幻风格设计：暗色背景、霓虹色文字、数字化动效
- 加入适量动态元素增强智能体感知：分析进度条、数据流动画、决策矩阵可视化
- 紧急关停按钮设计为醒目的红色，位置固定且易于访问

## 6. 用户帮助 (优先级：中)

- 简化为基础工具提示
- 关键功能的简短说明文本
- 一个简单的常见问题页面
- 私钥安全保管指南

## 7. 验收标准

1. 用户能成功创建Agent并注入资金
2. Dashboard能准确显示Agent状态和收益
3. 用户能执行基本操作：暂停、继续、提款
4. 系统能在风险阈值触发时自动清仓
5. 用户能安全导出和导入私钥
6. Agent日志实时展示操作信息，强化智能体形象
7. 紧急关停功能能在30秒内响应并开始执行
8. 关停过程中的每个步骤状态清晰可见
9. 关停完成后，所有资产成功转换为SOL

## 8. 两阶段开发计划

### 8.1 第一阶段 (必要功能)

- Agent创建和基本设置
- 资金注入和提取
- 简化版Dashboard
- 基础自动运行功能
- 私钥导出功能
- 基础Agent智能日志
- 紧急关停机制

### 8.2 第二阶段 (可选功能)

- 更详细的收益分析
- 高级风险设置
- 完整交易历史
- 通知系统
- 高级Agent日志（更复杂的AI分析模拟）

## 9. Agent智能日志示例

```
[2024-03-10 08:14:32] 初始化Agent_07... 连接Solana主网... 验证资金... 就绪
[2024-03-10 08:15:01] 开始市场分析周期。扫描Meteora池子数据...
[2024-03-10 08:15:17] 分析中: 检测到100个活跃池子，应用流动性和交易量过滤器...
[2024-03-10 08:15:42] 关注焦点: SOL-USDC, BONK-SOL, JTO-USDC池子显示异常高收益
[2024-03-10 08:16:01] 风险评估: BONK-SOL波动率23.4%，高于阈值，执行深度分析...
[2024-03-10 08:16:35] 决策矩阵计算完成：选择SOL-USDC池，预期24h收益率7.2%
[2024-03-10 08:16:52] 执行交易: 分配1.5 SOL至SOL-USDC池，设定价格区间11.23-12.69
[2024-03-10 08:17:05] 交易确认，哈希: 4tLRZEHDxXh8fkKDzpLmUxzUKnTC16tgbHjDmJXkbGbeSZWdMEcdETiWMa6LK
[2024-03-10 08:17:08] 仓位建立完成。开始监控。预警设置：价格偏离>8%，流动性减少>20%
[2024-03-10 08:32:14] 监控更新：SOL-USDC池性能符合预期，当前收益率6.9%
[2024-03-10 09:15:22] 检测到大额LP移除事件，分析影响中...评估结果：影响有限，维持仓位
[2024-03-10 09:47:11] 市场趋势变化：SOL价格上涨2.7%，调整收益预期至8.1%

// 紧急关停日志示例
[2024-03-10 10:05:44] ⚠️ 检测到用户发起紧急关停命令
[2024-03-10 10:05:45] ⚠️ 暂停所有新操作。开始执行关停流程...
[2024-03-10 10:05:47] ⚠️ 检索当前活跃池子：SOL-USDC(1.2 SOL), JTO-USDC(0.8 SOL), BONK-SOL(0.5 SOL)
[2024-03-10 10:05:52] ⚠️ 开始从SOL-USDC池移除流动性...
[2024-03-10 10:06:04] ⚠️ SOL-USDC池移除完成，获得0.9 SOL和28.4 USDC
[2024-03-10 10:06:06] ⚠️ 开始从JTO-USDC池移除流动性...
[2024-03-10 10:06:14] ⚠️ JTO-USDC池移除完成，获得45.6 JTO和21.2 USDC
[2024-03-10 10:06:18] ⚠️ 开始从BONK-SOL池移除流动性...
[2024-03-10 10:06:26] ⚠️ BONK-SOL池移除完成，获得0.4 SOL和12500 BONK
[2024-03-10 10:06:28] ⚠️ 所有LP仓位已清空，开始执行资产转换...
[2024-03-10 10:06:30] ⚠️ 使用Jupiter寻找最优Swap路径：USDC → SOL
[2024-03-10 10:06:38] ⚠️ USDC兑换完成，获得1.6 SOL
[2024-03-10 10:06:42] ⚠️ 使用Jupiter寻找最优Swap路径：JTO → SOL
[2024-03-10 10:06:49] ⚠️ JTO兑换完成，获得0.7 SOL
[2024-03-10 10:06:53] ⚠️ 使用Jupiter寻找最优Swap路径：BONK → SOL
[2024-03-10 10:07:01] ⚠️ BONK兑换完成，获得0.3 SOL
[2024-03-10 10:07:05] ⚠️ 紧急关停流程完成。最终余额：3.9 SOL
[2024-03-10 10:07:06] Agent已关闭。所有监控和自动操作已终止。



# Agent系统-交易模块

## 1. 概述

交易模块是Agent系统的核心执行引擎，负责根据信号系统的分析结果，制定并执行LP投资策略。该模块自动完成资产分配、代币交换和流动性提供等操作，使用户无需手动监控或干预即可获得DeFi LP投资收益。

## 2. 核心功能设计

### 2.1 策略制定模块 (优先级：高)

**输入数据处理**：
- 从信号系统接收T1级别池子数据（最多3个）
- 解析池子详细信息（代币对、价格区间、预期收益率等）
- 检索Agent当前资产状况（SOL余额）

**仓位策略计算**：
- 根据可用SOL余额计算可分配资金
- 应用资金分配算法确定每个池子的投资金额：
  - 低风险偏好：平均分配策略（每个池子资金相等）
  - 中风险偏好：加权分配策略（根据预期收益率加权）
  - 高风险偏好：集中分配策略（向最高预期收益池子倾斜）
- 执行仓位占比限制：单个池子不超过总资产的50%

**收益预测**：
- 基于池子历史数据计算预期24小时收益
- 提供收益区间（最低/预期/最高）
- 计算年化收益率估算

**边界条件处理**：
- 最小投资金额检查（每个池子至少0.1 SOL）
- 剩余SOL保留量（至少0.05 SOL用于交易费用）
- 池子容量检查（避免大额资金对小池子造成过大影响）

### 2.2 Swap执行模块 (优先级：高)

**交易预处理**：
- 根据策略确定需要交换的SOL数量和目标代币
- 针对每个池子计算最佳Swap分配比例
- 构建交易队列并设置优先级

**Jupiter API集成**：
- 调用Jupiter API查询最优交换路径
- 获取价格影响和滑点估算
- 验证交易路径安全性和效率

**滑点控制**：
- 设置最大可接受滑点（默认0.5%，可根据风险偏好调整）
- 实现动态滑点调整算法（根据池子流动性和交易量自动调整）
- 大额交易自动分批执行（单笔超过池子24小时交易量的5%时）

**MEV防护**：
- 实现私有交易路由（避免公共内存池曝光）
- 使用Jupiter的RPC端点以减少MEV风险
- 应用随机时间延迟策略（±1-3秒随机延迟）

**异常处理**：
- 交易失败自动重试机制（最多3次，间隔递增）
- 滑点超限降级策略（自动降低交易金额或分批执行）
- 网络拥堵应对策略（动态调整gas费用或延迟执行）

### 2.3 LP提供模块 (优先级：高)

**流动性参数计算**：
- 读取T1池子推荐的最佳价格区间
- 计算DLMM Bin分布：
  - 稳定币对：集中式分布（80%流动性集中在±1%价格区间）
  - 中波动币对：平衡式分布（70%流动性分布在±5%价格区间）
  - 高波动币对：梯度式分布（从中心向边缘递减分布在±10%价格区间）
- 确定最佳bin step参数（基于池子波动特性和推荐值）

**智能价格区间设置**：
- 基于当前市场价格设定LP价格区间
- 应用动态调整算法拓展价格区间（根据近期波动率）
- 确保价格区间与实际Bin边界对齐

**LP交易执行**：
- 构建LP添加交易指令
- 设置gas价格和优先级
- 执行交易并获取交易确认
- 验证LP位置开设成功

**资产平衡优化**：
- 确保代币对比例匹配池子需求
- 优化未使用代币（小额剩余代币自动添加到LP或换回SOL）
- 执行资金利用率最大化策略

## 3. 工作流程

### 3.1 单个池子投资流程

1. **策略确定**：
   - 接收池子数据（例如：SOL-USDC）
   - 计算投资金额（例如：1.5 SOL）
   - 确定最佳流动性分布和价格区间

2. **Swap准备**：
   - 计算需要交换的SOL数量（例如：0.75 SOL换成USDC）
   - 查询最优交换路径
   - 验证滑点和价格影响在可接受范围

3. **执行Swap**：
   - 发送交易到链上
   - 监控交易状态直到确认
   - 验证最终收到的代币数量

4. **提供LP**：
   - 计算最佳Bin分布
   - 构建并发送LP添加交易
   - 确认LP成功添加并记录位置信息

5. **结果记录**：
   - 记录交易详情（交易哈希、时间戳、金额）
   - 更新Agent资产状态
   - 计算并记录预期收益

### 3.2 多池子并行投资流程

1. **总体策略**：
   - 确定可用资金总额
   - 按预定策略分配资金到多个池子
   - 建立优先级执行队列

2. **批量Swap**：
   - 按优先级依次执行Swap
   - 每个Swap完成后更新资金状态
   - 处理单个Swap失败的回退机制

3. **批量添加LP**：
   - 按优先级依次执行LP添加
   - 每个LP添加完成后更新仓位状态
   - 处理单个LP添加失败的回退机制

4. **投资完成报告**：
   - 生成完整投资报告
   - 汇总预期收益
   - 更新Agent总体状态

## 4. 关键算法与策略

### 4.1 资金分配算法

**基础分配逻辑**：
```

可投资金额 = 总SOL余额 - 保留金额(0.05 SOL)

低风险策略：
每个池子投资金额 = 可投资金额 / 池子数量

中风险策略：
权重因子[i] = 池子[i].预期收益率 / Σ(所有池子.预期收益率)
池子[i]投资金额 = 可投资金额 \* 权重因子[i]

高风险策略：
权重因子[i] = (池子[i].预期收益率)² / Σ(所有池子.(预期收益率)²)
池子[i]投资金额 = 可投资金额 \* 权重因子[i]

```

### 4.2 流动性分布算法

**Bin分布计算**：
```

// 根据池子波动特性确定价格区间
if (池子类型 == "稳定币对") {
价格区间百分比 = 1%
集中度 = 80%
} else if (池子类型 == "中波动币对") {
价格区间百分比 = 5%
集中度 = 70%
} else { // 高波动币对
价格区间百分比 = 10%
集中度 = 60%
}

// 计算价格边界
中心价格 = 当前市场价格
下边界 = 中心价格 _ (1 - 价格区间百分比)
上边界 = 中心价格 _ (1 + 价格区间百分比)

// 映射到实际bin
下边界bin = 找到最接近下边界价格的bin
上边界bin = 找到最接近上边界价格的bin
总bin数 = 上边界bin - 下边界bin + 1

// 流动性分配
if (分布策略 == "集中式") {
// 80%流动性在中心区域，20%在边缘
中心区域bin数 = Math.floor(总bin数 _ 0.3)
每个中心bin流动性 = (总流动性 _ 集中度) / 中心区域bin数
每个边缘bin流动性 = (总流动性 \* (1-集中度)) / (总bin数 - 中心区域bin数)
} else if (分布策略 == "平衡式") {
// 均匀分布
每个bin流动性 = 总流动性 / 总bin数
} else { // 梯度式
// 从中心向边缘递减
// 实现线性或指数递减算法
}

```

### 4.3 滑点控制算法

```

// 动态滑点调整
基础滑点容忍度 = 0.5%

if (交易金额 > 池子24h交易量的5%) {
// 大额交易增加滑点容忍度
滑点容忍度 = 基础滑点容忍度 _ (1 + 0.1 _ (交易金额 / 池子24h交易量))
} else {
滑点容忍度 = 基础滑点容忍度
}

// 设置最大上限
滑点容忍度 = Math.min(滑点容忍度, 2%)

// 大额交易分批处理
if (交易金额 > 池子24h交易量的10%) {
批次数量 = Math.ceil(交易金额 / (池子24h交易量 \* 0.05))
每批金额 = 交易金额 / 批次数量
}

```

## 5. 异常处理与风险控制

### 5.1 交易失败处理

**重试策略**：
- 首次失败后等待5秒重试
- 第二次失败后等待15秒重试
- 第三次失败后等待30秒重试
- 三次失败后记录错误并通知用户

**失败分类与响应**：
- 滑点超限：自动调整滑点容忍度或分批执行
- Gas不足：增加gas费用并重试
- 网络拥堵：延迟执行并定期重试
- 资金不足：重新计算可用余额并调整策略
- 未知错误：记录详细错误信息，回滚操作

### 5.2 风险防护措施

**交易安全保障**：
- 设置单笔交易最大金额限制
- 实现交易前后余额验证
- 维护安全的RPC端点列表

**MEV保护策略**：
- 随机化交易提交时间
- 使用私有交易路由
- 监控异常Gas价格波动

**资金安全监控**：
- 每次交易前后验证资产变化
- 定期对账检查，确保实际资产与记录一致
- 异常变动自动冻结并报警

## 6. 技术实现考量

### 6.1 系统架构

**模块化设计**：
- 策略引擎：负责仓位计算和决策
- 交易执行器：负责与区块链交互
- 状态管理器：维护资产和交易状态
- 日志记录器：记录所有操作和结果

**内部通信机制**：
- 基于消息队列的异步通信
- 事件驱动架构
- 状态变更通知

### 6.2 性能优化

**并行处理**：
- 允许多个小额Swap并行执行
- LP添加操作与Swap交易分离
- 预计算和缓存常用参数

**批处理机制**：
- 合并同类型交易减少Gas消耗
- 使用批量查询减少API调用次数
- 实现交易队列管理

### 6.3 外部依赖

**Jupiter API集成**：
- 使用Jupiter SDK进行路由查询和交易构建
- 实现高可用性策略，防止单点故障
- 缓存常用路由信息减少API调用

**Meteora DLMM交互**：
- 使用官方SDK进行LP操作
- 实现池子参数本地计算
- 优化Gas使用策略

## 7. 验收标准

1. **基本功能**：
   - 能够成功从信号系统接收T1级别池子数据
   - 正确计算资金分配和仓位策略
   - 成功执行Swap交易，滑点控制在设定范围内
   - 成功提供LP，价格区间符合策略要求

2. **执行效率**：
   - 从策略制定到执行完成整个流程平均耗时<2分钟
   - Swap交易滑点平均<0.8%
   - LP提供成功率>95%

3. **风险控制**：
   - 成功防御所有已知MEV攻击
   - 异常交易自动回滚成功率100%
   - 交易失败时能正确保留用户资金

4. **应对极端情况**：
   - 网络拥堵时能够调整策略并成功执行
   - 价格剧烈波动时能启动保护机制
   - 流动性突变时能及时调整策略

## 8. 开发优先级与阶段

### 8.1 第一阶段 (核心功能)
- 基础策略制定算法
- 简单Swap执行（固定滑点）
- 基础LP提供功能
- 简单错误处理

### 8.2 第二阶段 (增强功能)
- 高级资金分配策略
- 动态滑点控制
- 智能Bin分布算法
- 完善的错误处理与重试

### 8.3 第三阶段 (优化功能)
- MEV防护增强
- 批量交易优化
- 高级风险控制
- 性能与效率优化

## 9. 交易执行日志示例

```

[2024-03-10 10:15:22] 开始执行新投资周期...
[2024-03-10 10:15:23] 接收T1池子数据：SOL-USDC(预期收益率7.2%)、JTO-USDC(预期收益率8.5%)、BONK-SOL(预期收益率9.3%)
[2024-03-10 10:15:24] 当前可用余额：2.5 SOL
[2024-03-10 10:15:25] 执行中风险策略资金分配...
[2024-03-10 10:15:26] 资金分配结果：SOL-USDC(0.7 SOL), JTO-USDC(0.8 SOL), BONK-SOL(0.9 SOL)
[2024-03-10 10:15:27] 预计24小时总收益：0.18 SOL (7.8%)

// SOL-USDC池子操作
[2024-03-10 10:15:30] 开始处理SOL-USDC池子投资...
[2024-03-10 10:15:31] 需要交换：0.35 SOL → USDC
[2024-03-10 10:15:32] 查询Jupiter最优路径：SOL → USDC
[2024-03-10 10:15:33] 最优路径已确认，预计获得9.8 USDC，滑点0.2%
[2024-03-10 10:15:34] 发送Swap交易...
[2024-03-10 10:15:42] 交易确认：0.35 SOL → 9.79 USDC (实际滑点0.22%)
[2024-03-10 10:15:43] 计算LP参数：中心价格$28.05，集中式分布，价格区间[$27.35, $28.75]
[2024-03-10 10:15:45] 发送LP提供交易...
[2024-03-10 10:15:52] LP提供完成：添加0.35 SOL + 9.79 USDC至价格区间[$27.35, $28.75]
[2024-03-10 10:15:53] SOL-USDC池子投资完成，预期24h收益率：7.2%

// 类似地处理其他池子...

[2024-03-10 10:16:30] 投资周期执行完成
[2024-03-10 10:16:31] 总结：成功投资3个池子，预期24h收益：0.18 SOL (7.8%)
[2024-03-10 10:16:32] 剩余可用余额：0.07 SOL

````

## 10. 交易模块与其他模块的接口

### 10.1 与信号系统的接口

**输入数据格式**：
```json
{
  "timestamp": "2024-03-10T10:15:00Z",
  "t1_pools": [
    {
      "pool_address": "ABC123...",
      "name": "SOL-USDC",
      "token_pair": {
        "token_x": {"symbol": "SOL", "address": "So11111..."},
        "token_y": {"symbol": "USDC", "address": "EPjF..."}
      },
      "metrics": {
        "liquidity": 1200000,
        "volume_24h": 500000,
        "fees_24h": 1500,
        "daily_yield": 0.072
      },
      "recommendation": {
        "price_range": {
          "min": 27.35,
          "max": 28.75,
          "current": 28.05
        },
        "bin_distribution": "集中式",
        "bin_step": 10
      }
    },
    // 其他池子数据...
  ]
}
````

### 10.2 与Dashboard的接口

**输出数据格式**：

```json
{
  "timestamp": "2024-03-10T10:16:32Z",
  "transactions": [
    {
      "type": "swap",
      "token_pair": "SOL-USDC",
      "amount_in": 0.35,
      "amount_out": 9.79,
      "slippage": 0.0022,
      "tx_hash": "4tLRZEHD...",
      "timestamp": "2024-03-10T10:15:42Z"
    },
    {
      "type": "add_liquidity",
      "pool": "SOL-USDC",
      "token_x": { "symbol": "SOL", "amount": 0.35 },
      "token_y": { "symbol": "USDC", "amount": 9.79 },
      "price_range": [27.35, 28.75],
      "tx_hash": "xUKnTC16...",
      "timestamp": "2024-03-10T10:15:52Z"
    }
    // 其他交易数据...
  ],
  "positions": [
    {
      "pool": "SOL-USDC",
      "value_usd": 29.6,
      "expected_daily_yield": 0.072,
      "expected_daily_fees": 0.051
    }
    // 其他仓位数据...
  ],
  "summary": {
    "total_invested": 2.43,
    "expected_daily_yield_rate": 0.078,
    "expected_daily_yield_sol": 0.18
  }
}
```

# Agent系统-监控模块

## 1. 概述

监控模块是Agent系统的风险管理核心，负责实时监控Agent的所有LP仓位，通过分析多维度指标评估池子健康程度。该模块为用户提供透明的风险洞察，并在检测到风险时生成警报信号，触发风控模块执行相应的保护措施。监控模块确保Agent能够及时识别市场变化带来的风险。

## 2. 核心功能设计

### 2.1 实时监控系统 (优先级：高)

**数据采集机制**：

- 每5分钟从链上获取LP池子最新状态
- 实时订阅池子地址的交易事件
- 定期获取代币相关链上统计数据
- 接入特定第三方数据源:
  - **Meteora DLMM API**: 获取池子详细数据
  - **Jupiter API**: 获取市场流动性和价格数据
  - **OKX DEX API**: 获取代币交易数据和市场深度信息

**关键监控指标**：

- 交易量(Volume)变化：多时间段颗粒度比对
  - 1小时变化率: 当前小时VS前一小时
  - 4小时变化率: 近4小时VS前4小时
  - 12小时变化率: 近12小时VS前12小时
  - 24小时变化率: 近24小时VS前24小时
  - 7天平均对比: 24小时VS过去7天日均
- 总锁仓量(TVL)变化：监控突发性增减
- 代币持有人数变化：识别代币集中度异常
- 代币价格波动：监控暴涨暴跌事件
- 大户LP行为：追踪已识别大户地址的添加/移除操作
- 单边LP风险：监控流动性分布偏斜程度

**实时警报系统**：

- 设置多级警报阈值（注意、警告、紧急）
- 基于权重组合多指标评估总体风险
- 突发事件立即通知机制

### 2.2 风险评分系统 (优先级：高)

**综合风险评分算法**：

- 1-5分制（1分=极高风险，5分=极低风险）
- 基于以下维度的加权评分：
  - 价格风险(30%)：代币价格波动性
  - 流动性风险(25%)：TVL突变、深度不足
  - 交易风险(20%)：交易量异常下降
  - 大户行为风险(15%)：大额LP移除
  - 代币基本面风险(10%)：持币地址集中度变化

**风险等级定义**：

- 1分(红色)：极高风险 - 建议立即行动
- 2分(橙色)：高风险 - 密切关注
- 3分(黄色)：中等风险 - 注意观察
- 4分(浅绿)：低风险 - 正常状态
- 5分(绿色)：极低风险 - 健康状态

**评分更新机制**：

- 常规指标每5分钟更新一次评分
- 重大事件触发时立即重新评分
- 保存历史评分记录用于趋势分析

### 2.3 大户行为监控 (优先级：中)

**大户地址识别**：

- 维护已知大户地址库
- 自动识别新的大额LP提供者
- 对大户地址的交易活动赋予更高权重

**行为模式分析**：

- 追踪大户添加/移除流动性的频率和规模
- 检测协同行为（多个大户同时操作）
- 分析大户操作与市场波动的相关性

**影响评估**：

- 计算大户行为对池子总体流动性的影响
- 评估大户离场对价格支撑的潜在影响
- 生成大户行为风险系数

### 2.4 单边LP检测 (优先级：中)

**不平衡监控**：

- 计算池子两侧资产比例
- 监控单边流动性累积情况
- 识别流动性分布异常偏斜

**单边LP风险系数计算**：

```
// 基础偏斜分数计算
偏斜百分比 = |X代币价值比例 - 50%| * 2  // 0-100范围
基础风险分数 = 偏斜百分比 / 10  // 0-10范围

// 价格区间调整
if (价格区间宽度 < 3%) {
  区间调整系数 = 1.5
} else if (价格区间宽度 < 10%) {
  区间调整系数 = 1.0
} else {
  区间调整系数 = 0.7
}

// 时间趋势调整
if (过去12小时偏斜趋势 == "加剧") {
  趋势调整系数 = 1.3
} else if (过去12小时偏斜趋势 == "稳定") {
  趋势调整系数 = 1.0
} else {
  趋势调整系数 = 0.8
}

// 计算最终风险系数(0-10分)
单边LP风险系数 = 基础风险分数 * 区间调整系数 * 趋势调整系数
```

**单边风险评估**：

- 分析单边LP导致的价格滑动风险
- 评估回归均衡所需的交易量
- 特别关注价格区间因素：
  - 窄区间单边LP(±3%以内): 风险系数×1.5
  - 中等区间单边LP(±3-10%): 风险系数×1.0
  - 宽区间单边LP(±10%以上): 风险系数×0.7

**预警设置**：

- 当单边LP比例超过65%时发出警告
- 当单边LP比例超过80%时发出高风险警报
- 自动降低健康评分

### 2.5 风险触发信号生成 (优先级：高)

**触发条件定义**：

- 部分减仓信号触发条件：

  - 健康度评分降至2.0-2.5之间持续10分钟
  - 单边LP风险系数>7持续15分钟
  - 大户在4小时内撤出总流动性>15%
  - 交易量在12小时内下降>65%

- 完全退出信号触发条件：
  - 健康度评分<=1.5持续5分钟
  - 健康度评分<2.0同时单边LP风险系数>8持续10分钟
  - 24小时内大户撤出总流动性>30%
  - 代币价格在4小时内下跌>25%
  - 交易量在24小时内下降>85%

**信号传递机制**：

- 生成包含详细风险数据的信号包
- 通过内部API传递给风控模块
- 记录信号发送历史和确认状态
- 实现信号重发和确认机制

**信号优先级管理**：

- 根据风险程度设置信号优先级
- 确保高优先级信号能快速处理
- 防止信号风暴机制（控制短时间内的信号数量）

## 3. 前端展示设计

### 3.1 健康度仪表盘 (优先级：高)

**主要视觉组件**：

- 圆形仪表盘，颜色从红到绿对应1-5分风险等级
- 清晰的数字分数显示（当前分数/5）
- 简洁的风险等级文字说明

**布局位置**：

- 在Agent详情页面中醒目位置
- 每个LP池子项旁显示对应的小型健康度指示器

**交互功能**：

- 点击仪表盘展开详细风险报告
- 悬停显示简要风险评估说明
- 支持历史健康度查看（7天趋势）

### 3.2 风险详情面板 (优先级：中)

**详细指标展示**：

- 分维度显示各项风险评分（雷达图）
- 列表展示所有监控指标的当前值与正常范围
- 高亮显示异常指标

**风险趋势图表**：

- 显示健康度评分的24小时变化曲线
- 标记重要事件点（大户移动、市场波动等）
- 提供1小时/6小时/24小时/7天视图切换

**预警消息区域**：

- 显示最近的警告和风险事件
- 提供详细的风险说明和建议操作
- 支持用户确认查看功能

### 3.3 池子监控卡片 (优先级：高)

**每个LP池子的监控卡片**：

- 显示池子名称、当前余额、收益率
- 健康度评分指示器（彩色小圆点或进度条）
- 关键变化指标（24小时TVL变化%、交易量变化%）

**状态变化视觉提示**：

- 健康度下降时颜色变化和动画效果
- 新警告出现时的闪烁提示
- 风控操作触发时的状态指示

**快速操作按钮**：

- 一键查看详情
- 手动触发风控操作
- 暂停自动监控选项

## 4. 技术实现考量

### 4.1 数据源整合

**链上数据来源**：

- Solana RPC节点实时查询池子状态
- 交易历史分析（使用多个RPC节点以提高可靠性）
- Web3事件订阅

**外部数据整合**：

- Meteora API获取池子统计数据
- Jupiter API获取价格和流动性数据
- OKX DEX API获取市场深度信息

**数据缓存机制**：

- 重要数据本地缓存以减少API调用
- 分层缓存策略（实时数据5分钟，历史数据1小时）
- 断网情况下使用缓存数据保持基本监控

### 4.2 性能优化

**实时监控效率**：

- 使用WebSocket连接实现高效实时更新
- 按池子重要性分配不同的监控频率
- 批量数据请求减少API调用次数

**资源使用控制**：

- 限制并发监控线程数量
- 动态调整监控频率（市场波动大时提高频率）
- 优化计算密集型指标的评估逻辑

### 4.3 可靠性保障

**故障恢复机制**：

- 监控系统心跳检测
- 自动重连和恢复监控
- 数据一致性校验防止错误传播

**冗余设计**：

- 多数据源备份策略
- 关键指标的多种计算路径
- 异常值检测和过滤

## 5. 与其他模块的接口

### 5.1 与风控模块的接口

**输出信号格式**：

```json
{
  "signal_id": "MS-2024031015452301",
  "timestamp": "2024-03-10T15:45:23Z",
  "signal_type": "risk_alert",
  "action_type": "full_exit",
  "priority": "high",
  "target_pool": {
    "pool_address": "ABC123...",
    "name": "JTO-USDC",
    "current_value_usd": 1245
  },
  "risk_assessment": {
    "health_score": 1.8,
    "risk_level": "high_risk",
    "trigger_factors": [
      {
        "factor": "whale_activity",
        "description": "35% pool liquidity removal in last 4h",
        "threshold": "15%",
        "severity": "critical"
      },
      {
        "factor": "volume_change",
        "description": "68% decrease in 12h volume",
        "threshold": "65%",
        "severity": "high"
      }
    ],
    "continuous_period": "15min"
  },
  "additional_data": {
    "price_volatility": 7.8,
    "tvl_change_24h": -22.5,
    "one_sided_lp_risk": 8.2
  }
}
```

### 5.2 与Dashboard的接口

**输出数据格式**：

```json
{
  "timestamp": "2024-03-10T12:30:00Z",
  "agent_overall_health": {
    "score": 3.8,
    "level": "低风险",
    "trend": "稳定",
    "alerts_count": 1
  },
  "positions_health": [
    {
      "pool": "SOL-USDC",
      "health_score": 4.2,
      "level": "低风险",
      "key_metrics": {
        "tvl_change_24h": -2.5,
        "volume_change_24h": 5.8,
        "price_volatility": 3.2,
        "whale_activity": "正常",
        "one_sided_lp_risk": "低"
      },
      "alerts": []
    },
    {
      "pool": "JTO-USDC",
      "health_score": 3.5,
      "level": "中等风险",
      "key_metrics": {
        "tvl_change_24h": -8.3,
        "volume_change_24h": -12.4,
        "price_volatility": 7.8,
        "whale_activity": "检测到大户移除",
        "one_sided_lp_risk": "中"
      },
      "alerts": [
        {
          "type": "whale_activity",
          "severity": "warning",
          "message": "检测到大户地址移除约15%流动性",
          "timestamp": "2024-03-10T12:15:22Z"
        }
      ]
    }
  ],
  "recent_events": [
    {
      "type": "whale_movement",
      "pool": "JTO-USDC",
      "description": "大户地址7NPtj...移除了约$25,000流动性",
      "impact": "中等",
      "timestamp": "2024-03-10T12:15:22Z"
    }
  ]
}
```

## 6. 验收标准

1. **监控准确性**：

   - 能够准确捕捉并报告90%以上的风险事件
   - 风险评分与实际池子健康状况的一致性>85%
   - 大户行为监控准确率>90%

2. **响应时效性**：

   - 常规数据更新延迟<30秒
   - 关键风险事件检测并通知时间<2分钟
   - 风险信号生成及传递时间<5秒

3. **系统稳定性**：

   - 监控模块24/7连续运行稳定性>99.5%
   - 故障自动恢复时间<5分钟
   - 资源占用在预期范围内

4. **前端展示**：
   - 健康度仪表盘正确反映后端风险评分
   - UI响应时间<1秒
   - 风险预警视觉提示明确且不易忽视

## 7. 开发优先级与阶段

### 7.1 第一阶段 (核心功能)

- 基础实时监控系统
- 简单风险评分机制（基于TVL和交易量）
- 基础健康度仪表盘
- 简单预警通知

### 7.2 第二阶段 (增强功能)

- 完整的多维度风险评分
- 大户行为监控
- 单边LP风险检测
- 高级风险详情面板

### 7.3 第三阶段 (优化功能)

- 风险触发信号完善
- 高级市场情报整合
- 历史风险分析与预测
- 用户自定义风险阈值

## 8. 风险监控示例日志

```
[2024-03-10 12:10:00] 执行SOL-USDC池定时健康检查...
[2024-03-10 12:10:05] 检索关键指标 - TVL:$1,235,600(↓2.5%), 24h交易量:$523,800(↑5.8%)
[2024-03-10 12:10:10] 分析价格波动性:3.2%(过去24小时标准差/均价)，稳定性良好
[2024-03-10 12:10:15] 检测大户活动:最近6小时内无显著变动
[2024-03-10 12:10:20] 评估单边LP风险:双边比例43:57，风险值低
[2024-03-10 12:10:25] 计算综合健康评分:4.2/5.0(低风险)

[2024-03-10 12:15:00] 执行JTO-USDC池定时健康检查...
[2024-03-10 12:15:05] 检索关键指标 - TVL:$897,400(↓8.3%), 24h交易量:$245,600(↓12.4%)
[2024-03-10 12:15:15] ⚠️ 检测到异常:大户地址7NPtj...移除了约$25,000流动性
[2024-03-10 12:15:20] 扫描链上数据:发现3个大户地址在过去1小时内合计移除约15%池子流动性
[2024-03-10 12:15:25] 分析价格波动性:7.8%(过去24小时)，波动性高于7天平均值
[2024-03-10 12:15:30] 评估单边LP风险:当前比例38:62，单边风险中等
[2024-03-10 12:15:35] 计算综合健康评分:3.5/5.0(中等风险)
[2024-03-10 12:15:40] 生成风险提醒:检测到大户移除流动性，建议密切关注

[2024-03-10 12:20:00] 更新Agent总体健康评分...
[2024-03-10 12:20:05] 汇总各池子评分:SOL-USDC(4.2), JTO-USDC(3.5), BONK-SOL(3.6)
[2024-03-10 12:20:10] 加权计算总体评分:3.8/5.0(低风险)
[2024-03-10 12:20:15] 评分趋势:过去24小时下降0.3分，仍在安全范围
```

## 9. 健康度评分算法详解

**综合健康度评分计算**：

```
// 1. 计算各维度原始分数(0-100)
价格风险原始分 = 100 - min(100, 价格波动率 * 1000)
流动性风险原始分 = 100 - min(100, TVL下降百分比 * 5)
交易风险原始分 = 100 - min(100, 交易量下降百分比 * 4)
大户风险原始分 = 100 - min(100, 大户移除占比 * 500)
单边风险原始分 = 100 - min(100, |双边比例差| * 2.5)

// 2. 归一化为1-5分制
价格风险分 = 1 + (价格风险原始分 / 100 * 4)
流动性风险分 = 1 + (流动性风险原始分 / 100 * 4)
交易风险分 = 1 + (交易风险原始分 / 100 * 4)
大户风险分 = 1 + (大户风险原始分 / 100 * 4)
单边风险分 = 1 + (单边风险原始分 / 100 * 4)

// 3. 加权计算最终评分
健康度评分 =
  价格风险分 * 0.30 +
  流动性风险分 * 0.25 +
  交易风险分 * 0.20 +
  大户风险分 * 0.15 +
  单边风险分 * 0.10

// 4. 风险等级映射
if (健康度评分 >= 4.5) return "极低风险"
else if (健康度评分 >= 3.5) return "低风险"
else if (健康度评分 >= 2.5) return "中等风险"
else if (健康度评分 >= 1.5) return "高风险"
else return "极高风险"
```

# Agent系统-风控模块

## 1. 概述

风控模块是Agent系统的执行防线，负责在监控模块发出风险信号后，执行具体的风控操作。该模块接收监控模块传递的风险触发信号，快速响应并执行LP移除和资产转换操作，将用户资产从风险池子安全撤出并转换为SOL，从而最大限度地保护用户资产安全。

## 2. 核心功能设计

### 2.1 风控信号接收与验证 (优先级：高)

**信号接收机制**：

- 接收监控模块发送的风险信号
- 解析信号内容和风险等级
- 确认信号的有效性和真实性
- 对重复信号进行过滤和合并

**行动类型解析**：

- 部分减仓信号（针对中等风险）
- 完全退出信号（针对高风险）
- 用户手动触发信号（最高优先级）

**信号确认流程**：

- 记录信号接收时间和详情
- 向监控模块发送确认回执
- 将信号加入执行队列
- 设置执行优先级

### 2.2 执行引擎 (优先级：高)

**执行队列管理**：

- 根据优先级排序待执行操作
- 暂停低优先级任务确保资源
- 防止信号风暴导致系统超载
- 维护操作执行状态

**执行前准备**：

- 锁定目标LP仓位
- 阻止其他模块操作该仓位
- 记录初始资产状态
- 构建执行计划

**执行流程控制**：

1. 验证当前状态（确认风险仍然存在）
2. 执行LP移除操作
3. 等待移除确认并验证结果
4. 执行代币转换操作
5. 验证最终资产状态
6. 生成执行报告

**资源管理**：

- 预留足够执行资源（计算、网络、RPC请求）
- 优化执行顺序减少资源竞争
- 监控资源使用情况动态调整

### 2.3 LP移除操作 (优先级：高)

**移除策略确定**：

- 根据风险信号确定移除比例：
  - 部分减仓：30%-60%（根据风险等级调整）
  - 完全退出：100%
- 验证仓位当前状态和价值
- 计算预期获得的代币数量

**交易构建与执行**：

- 构建LP移除交易指令
- 设置合适的gas费用（确保快速确认）
- 发送交易并获取交易哈希
- 监控交易确认状态

**结果验证**：

- 确认LP移除成功
- 验证获得的代币数量是否符合预期
- 更新资产状态记录
- 准备进入下一步操作

### 2.4 代币转换操作 (优先级：高)

**Swap计划制定**：

- 识别需要转换的代币种类和数量
- 通过Jupiter API查询最佳兑换路径
- 根据代币流动性确定转换策略：
  - 大额：分批处理
  - 小额：直接处理
- 设置可接受的最大滑点（紧急情况下可提高）

**交易执行与监控**：

- 按计划顺序执行Swap交易
- 实时监控交易确认状态
- 处理交易异常（自动重试、调整策略）
- 验证每笔交易后的资产变化

**滑点优化与防护**：

- 大额交易分批执行（单笔不超过池子24小时交易量的5%）
- 动态调整滑点容忍度（基于风险紧急程度）
- 通过合适的交易路径最小化滑点
- 特殊情况下接受更高滑点以确保快速退出

### 2.5 结果验证与报告 (优先级：中)

**资产核对**：

- 统计风控操作前后的资产变化
- 验证所有代币是否成功转换为SOL
- 检查是否有小额代币残留
- 计算资产保全率和转换成本

**执行报告生成**：

- 记录完整的操作时间线
- 详细记录每笔交易的结果
- 汇总资产变化情况
- 分析执行效率和成本

**状态更新**：

- 向Dashboard发送执行结果
- 更新Agent整体状态
- 设置风控冷却期
- 解锁正常操作

## 3. 异常处理机制

### 3.1 交易失败处理 (优先级：高)

**重试策略**：

- LP移除失败：最多重试3次，间隔递增（5秒、15秒、30秒）
- Swap失败：最多重试3次，可能调整路径或滑点
- 持续失败：降级策略，尝试更小金额或替代方案

**网络异常处理**：

- RPC节点故障：自动切换备用节点
- 网络拥堵：增加gas费用，确保优先处理
- 确认超时：主动查询交易状态

**降级执行方案**：

- 拆分大额交易为多笔小额交易
- 调整交易参数（增加滑点容忍度）
- 尝试替代交易路径
- 最后手段：保留部分资产等待网络恢复

### 3.2 资产保护机制 (优先级：高)

**交易安全校验**：

- 每笔交易前预估结果与阈值比对
- 异常滑点检测与防护
- 禁止危险交易模式（如未知合约交互）
- 交易后余额变化验证

**极端情况保障**：

- 市场剧烈波动时的特殊处理
- 流动性枯竭时的分阶段执行
- 保留部分资产以支付交易费用
- 关键操作执行超时保护

## 4. 用户界面集成

### 4.1 执行状态展示 (优先级：中)

**实时进度指示**：

- 风控执行状态实时更新
- 当前执行步骤可视化
- 整体进度百分比显示
- 预计完成时间倒计时

**操作细节展示**：

- 已完成操作的详细记录
- 交易确认状态和链上链接
- 资产变化实时更新
- 异常情况清晰提示

### 4.2 执行结果报告 (优先级：中)

**操作总结**：

- 风控触发原因简明说明
- 执行时间和总耗时
- 资产变化总结（前vs后）
- 执行成本统计

**详细交易记录**：

- 每笔交易的详细信息
- 交易哈希和确认时间
- 滑点和费用明细
- 异常处理记录

## 5. 与其他模块的接口

### 5.1 与监控模块的接口

**输入接口**：

- 接收风险触发信号
- 获取目标池子详细信息
- 接收风险评估数据
- 监听风险等级变化

**输出接口**：

- 发送信号确认回执
- 报告执行开始状态
- 通知执行进度更新
- 发送执行完成结果

### 5.2 与交易模块的接口

**命令发送**：

- 请求执行LP移除操作
- 请求执行Swap交易
- 设置交易优先级和参数
- 取消或修改待执行交易

**状态接收**：

- 获取交易执行结果
- 监听交易确认状态
- 接收余额更新通知
- 获取交易异常报告

### 5.3 与Dashboard的接口

**输出数据格式**：

```json
{
  "timestamp": "2024-03-10T15:45:47Z",
  "event_id": "RC-2024031015452301",
  "status": "completed",
  "type": "full_exit",
  "trigger_source": "risk_threshold",
  "target_pool": "JTO-USDC",
  "execution_summary": {
    "start_time": "2024-03-10T15:45:25Z",
    "end_time": "2024-03-10T15:46:12Z",
    "total_duration_sec": 47,
    "initial_value_usd": 1245,
    "final_value_sol": 9.87,
    "final_value_usd": 1215,
    "value_preservation": "97.6%",
    "transaction_cost_sol": 0.012
  },
  "execution_steps": [
    {
      "step": "remove_lp",
      "status": "completed",
      "start_time": "2024-03-10T15:45:27Z",
      "end_time": "2024-03-10T15:45:42Z",
      "tx_hash": "4vLRZEHDxXh8fkKDzpLmUxzUKnTC16tgbHjDmJXkbGbe",
      "result": {
        "token_x": { "symbol": "JTO", "amount": 125.5 },
        "token_y": { "symbol": "USDC", "amount": 245.8 }
      }
    },
    {
      "step": "swap_token_x",
      "status": "completed",
      "start_time": "2024-03-10T15:45:43Z",
      "end_time": "2024-03-10T15:45:55Z",
      "tx_hash": "SZWdMEcdETiWMa6LKGSy7B3Q2Ck9QrxP8QwNHFKVMtbx",
      "result": {
        "input": { "symbol": "JTO", "amount": 125.5 },
        "output": { "symbol": "SOL", "amount": 4.32 },
        "slippage": "1.2%"
      }
    },
    {
      "step": "swap_token_y",
      "status": "completed",
      "start_time": "2024-03-10T15:45:56Z",
      "end_time": "2024-03-10T15:46:10Z",
      "tx_hash": "QFLyvdKr3X6GjNmKqMsGu2A9YKMnf8d37mWDNxXLhTvZ",
      "result": {
        "input": { "symbol": "USDC", "amount": 245.8 },
        "output": { "symbol": "SOL", "amount": 5.55 },
        "slippage": "0.8%"
      }
    }
  ]
}
```

## 6. 技术实现考量

### 6.1 性能优化

**响应时间优化**：

- 风控信号接收到执行开始<2秒
- 交易构建和发送<1秒
- 执行结果验证和处理<0.5秒

**资源优化**：

- 预编译交易模板
- 缓存常用参数和查询结果
- 批量处理API请求
- 共享连接池和资源

### 6.2 可靠性保障

**容错设计**：

- 全链路监控和重试
- 状态记录和恢复机制
- 关键步骤事务化处理
- 失败安全策略（确保最小资产损失）

**应急预案**：

- 定义明确的降级流程
- 极端情况下的手动接管机制
- 完整的错误日志和诊断信息
- 自动恢复和修复能力

## 7. 验收标准

1. **功能完整性**：

   - 成功接收和处理监控模块的所有风险信号类型
   - 正确执行LP移除和代币转换操作
   - 生成准确的执行报告和结果验证

2. **执行效率**：

   - 从信号接收到开始执行<2秒
   - 标准风控操作（移除LP+代币转换）完成时间<2分钟
   - 资产保全率>95%（考虑滑点和费用）

3. **可靠性与稳定性**：

   - 交易失败时自动重试成功率>95%
   - 执行异常时正确降级处理比例>90%
   - 极端市场条件下（高波动、高拥堵）仍能完成风控

4. **用户体验**：
   - 风控执行进度实时可见
   - 执行结果清晰报告
   - 异常情况及时通知
   - 操作历史可追溯

## 8. 开发优先级与阶段

### 8.1 第一阶段 (核心功能)

- 风控信号接收与基本验证
- LP移除基础功能
- 简单代币转SOL功能
- 基础执行报告

### 8.2 第二阶段 (增强功能)

- 完整风控执行流程
- 高级异常处理
- 资产验证与保护
- 详细执行报告

### 8.3 第三阶段 (优化功能)

- 执行性能优化
- 高级滑点控制
- 极端情况处理
- 用户界面完善

## 9. 风控执行示例日志

```
[2024-03-10 15:45:23] 接收风险信号: ID=MS-2024031015452301, 目标池=JTO-USDC, 风险等级=高
[2024-03-10 15:45:24] 验证信号有效性: 有效, 信号来源=监控模块
[2024-03-10 15:45:25] 开始执行风控操作: 行动类型=完全退出, 优先级=高
[2024-03-10 15:45:26] 锁定目标仓位: JTO-USDC, 当前价值=$1,245
[2024-03-10 15:45:27] 构建LP移除交易: 移除比例=100%
[2024-03-10 15:45:30] 发送LP移除交易: 哈希=4vLRZEHDxXh8fkKDzpLmUxzUKnTC16tgbHjDmJXkbGbe
[2024-03-10 15:45:42] LP移除交易确认: 获得JTO=125.5, USDC=245.8
[2024-03-10 15:45:43] 开始代币转换: 第一步=JTO→SOL
[2024-03-10 15:45:44] 查询最佳交换路径: JTO→SOL, 预期滑点=1.1%
[2024-03-10 15:45:45] 发送Swap交易: 哈希=SZWdMEcdETiWMa6LKGSy7B3Q2Ck9QrxP8QwNHFKVMtbx
[2024-03-10 15:45:55] JTO→SOL交换完成: 获得SOL=4.32, 实际滑点=1.2%
[2024-03-10 15:45:56] 开始下一步转换: USDC→SOL
[2024-03-10 15:45:57] 查询最佳交换路径: USDC→SOL, 预期滑点=0.7%
[2024-03-10 15:45:58] 发送Swap交易: 哈希=QFLyvdKr3X6GjNmKqMsGu2A9YKMnf8d37mWDNxXLhTvZ
[2024-03-10 15:46:10] USDC→SOL交换完成: 获得SOL=5.55, 实际滑点=0.8%
[2024-03-10 15:46:11] 验证最终资产: 总获得SOL=9.87, 对应价值=$1,215
[2024-03-10 15:46:12] 风控操作完成: 资产保全率=97.6%, 总执行时间=47秒
[2024-03-10 15:46:13] 生成执行报告: ID=RC-2024031015452301
[2024-03-10 15:46:14] 向Dashboard发送执行结果
[2024-03-10 15:46:15] 设置风控冷却期: 24小时内不自动重入该池子
```

# Agent系统-计算模块

## 1. 概述

计算模块是Agent系统的数据分析引擎，负责实时计算和展示用户LP仓位的收益情况。该模块主要利用系统内部已有的交易数据和必要的链上查询，通过多维度分析计算收益来源和表现，并将结果以可视化方式展示在Dashboard上，帮助用户全面了解投资表现并作出明智决策。

## 2. 核心功能设计

### 2.1 收益数据来源与采集 (优先级：高)

**主要数据来源**：

- **系统内部数据**（优先使用）：

  - Agent执行的交易记录：交易模块存储的历史交易
  - LP添加/移除记录：精确的时间、数量和价格信息
  - 资金注入/提取记录：Agent管理模块的资金流动记录
  - 风控操作记录：风控模块记录的所有风控行为

- **必要的链上数据**：
  - Meteora DLMM池子合约状态：通过系统RPC节点查询
  - 池子交易费用累计值：通过合约存储的feeGrowthGlobal变量
  - LP位置信息：通过Position NFT关联的数据账户
  - 代币价格数据：使用系统交易模块已缓存的价格数据

**数据获取优化**：

- 优先使用系统内已记录的历史数据
- 仅在必要时进行链上查询（如获取最新状态）
- 批量处理链上查询减少RPC调用
- 使用系统内现有价格数据，避免额外API依赖

**数据存储策略**：

- 实时数据：内存缓存（系统已有组件）
- 短期历史数据：使用系统现有数据库（30天内）
- 长期历史数据：压缩存储（仅保留关键聚合数据）

### 2.2 收益计算引擎 (优先级：高)

**多维度收益分析**：

- **费用收入计算**：
  - 数据来源：系统记录的LP操作 + 必要的链上查询
  - 计算方法：当前feeGrowthGlobal - 入场时feeGrowthGlobal × LP份额比例
  - 验证方法：结合系统内交易记录交叉验证
- **代币价值变化计算**：
  - 数据来源：系统内交易记录 + 当前合约状态
  - 计算方法：当前LP可提取代币价值 - 初始投入代币价值
  - 价格数据：优先使用系统交易模块已有的价格数据
- **综合收益率计算**：
  - 数据来源：组合上述计算结果 + 系统交易历史
  - 计算方法：(当前价值 + 已提取价值 - 投入价值) / 投入价值
  - 时间维度：日/周/月收益率（基于系统记录的时间点）

**计算方法与公式**：

```
// 基本数据获取
初始投资价值 = 系统交易记录中LP添加时的代币总价值(USD)
当前LP价值 = 通过合约查询当前Position可提取的代币数量 × 系统记录的当前代币价格
已收取费用 = 通过合约查询计算的累计费用

// 收益率计算
总收益 = 当前LP价值 + 已提取价值 - 初始投资价值
收益率 = 总收益 / 初始投资价值 * 100%
年化收益率 = ((1 + 收益率) ^ (365 / 持有天数) - 1) * 100%

// 费用vs价格变动分解
费用收益占比 = 已收取费用 / 总收益 * 100%
价格变动收益占比 = (总收益 - 已收取费用) / 总收益 * 100%
```

**计算优化**：

- 使用增量计算方法减少重复运算
- 缓存中间结果提高响应速度
- 处理部分添加/移除LP对计算的影响
- 考虑交易成本（gas费、滑点）对实际收益的影响

### 2.3 实时仪表盘数据 (优先级：高)

**核心指标输出**：

- 当前总资产价值(USD和SOL)：基于系统内最新价格数据
- 总收益(USD和SOL)和收益率：综合计算结果
- 24小时/7天/30天收益率：基于系统内历史数据点
- 当前年化收益率(APR)：基于最近7天实际收益估算
- 活跃池子数量和分布：系统内当前活跃的LP仓位数据

**每个池子的详细指标**：

- 池子当前价值：合约查询 + 系统价格数据
- 累计收益和收益率：历史记录 + 当前状态计算
- 收益构成(交易费用vs代币价值变化)：详细计算分解
- 预计24小时收益率：基于池子近期历史数据
- 池子健康度分数：直接从监控模块获取

### 2.4 历史数据分析 (优先级：中)

**历史表现记录**：

- 收益历史曲线：基于系统内存储的每日计算结果
- 关键事件标记：系统内各模块记录的重要操作
- 池子组合变更历史：交易模块记录的LP操作
- 收益归因分析：基于系统内历史数据的计算

**数据计算策略**：

- 每日计算：基础收益指标和总体表现
- 每周汇总：详细分解和归因分析
- 按需计算：用户查看详情时执行

### 2.5 数据可视化准备 (优先级：中)

**图表数据准备**：

- 时间序列数据：预处理为前端图表所需格式
- 分类数据：计算汇总统计和百分比
- 对比数据：计算相对表现和变化趋势
- 动态更新：支持实时更新的数据结构

**前端集成格式**：

- 标准化JSON数据输出
- 支持增量更新的数据结构
- 包含完整图表配置元数据

## 3. 用户界面集成

### 3.1 Dashboard收益卡片 (优先级：高)

**总体收益卡片**：

- 总收益率显示：计算模块提供最新计算值
- 累计收益金额(SOL和USD)：综合计算结果
- 24小时变化趋势：对比昨日同时段数据
- 收益构成比例：费用收入vs代币价值变化

**时间段切换**：

- 快速切换按钮：调用不同时间范围的计算数据
- 对应时间段数据：从缓存或实时计算获取
- 趋势指标：计算选定时间段内的变化率

### 3.2 池子收益明细 (优先级：中)

**池子收益列表**：

- 关键指标：每个池子的核心收益数据
- 变化指标：与前一时段相比的增减情况
- 健康度指标：直接从监控模块获取

**池子详情数据**：

- 详细收益分析：计算模块提供的深度分析
- 历史表现：基于系统存储的历史数据
- 对比数据：当前池子vs系统平均表现

## 4. 技术实现考量

### 4.1 数据架构

**数据流设计**：

- 系统内部数据 → 数据整合 → 计算引擎 → 结果缓存/输出
- 必要链上数据 → 批量查询 → 数据预处理 → 计算引擎 → 结果合并

**数据访问优化**：

- 减少重复链上查询
- 批量处理RPC请求
- 利用系统内现有数据缓存
- 避免不必要的外部API调用

### 4.2 性能优化

**计算效率优化**：

- 增量计算而非全量重算
- 预计算常用时间段的收益数据
- 分层缓存策略减少重复计算
- 异步计算非关键指标

**资源使用控制**：

- 限制链上查询频率
- 计算任务优先级管理
- 按需计算复杂指标
- 复用系统内现有数据

## 5. 与其他模块的接口

### 5.1 数据输入接口

**从交易模块获取**：

- 交易执行记录：精确的交易时间、数量和价格
- 交易成本数据：每笔交易的gas费用和滑点
- LP操作记录：添加/移除的确切时间和数量
- 代币价格数据：系统已记录的价格信息

**从监控模块获取**：

- 池子健康度评分：最新的风险评估结果
- 池子状态数据：交易量和TVL变化等指标

**从Agent管理模块获取**：

- 用户资金操作：注入/提取记录
- Agent状态变更：启动/暂停/关闭时间点

### 5.2 数据输出接口

**向Dashboard提供**：

```json
{
  "timestamp": "2024-03-10T14:30:00Z",
  "overall_metrics": {
    "total_value_usd": 2545.78,
    "total_value_sol": 21.84,
    "total_profit_usd": 215.35,
    "total_profit_sol": 1.85,
    "total_roi_percentage": 9.2,
    "daily_yield": {
      "value": 0.72,
      "trend": "up",
      "change": 0.05
    },
    "weekly_yield": {
      "value": 4.85,
      "trend": "up",
      "change": 0.2
    },
    "monthly_yield": {
      "value": 18.4,
      "trend": "up",
      "change": -0.35
    },
    "current_apr": 115.7,
    "profit_composition": {
      "fees": 65.2,
      "token_value": 34.8
    }
  },
  "pools_metrics": [
    {
      "pool": "SOL-USDC",
      "value_usd": 1235.45,
      "roi_percentage": 11.8,
      "daily_yield": 0.85,
      "fees_collected_usd": 85.32,
      "token_value_change_usd": 46.25,
      "health_score": 4.2,
      "estimated_next_24h": 0.82
    },
    {
      "pool": "JTO-USDC",
      "value_usd": 765.23,
      "roi_percentage": 7.4,
      "daily_yield": 0.65,
      "fees_collected_usd": 45.85,
      "token_value_change_usd": 12.35,
      "health_score": 3.7,
      "estimated_next_24h": 0.64
    }
  ],
  "historical_data": {
    "daily_returns": [
      { "date": "2024-03-09", "return": 0.68 },
      { "date": "2024-03-08", "return": 0.75 }
      // ... additional historical data
    ]
  }
}
```

## 6. 验收标准

1. **计算准确性**：

   - 收益计算与链上实际数据一致性>99%
   - 费用收入计算误差<0.1%
   - 综合收益率计算与手动验证一致

2. **性能指标**：

   - 基础指标计算响应时间<1秒
   - 详细分析数据加载时间<3秒
   - 历史数据分析(30天)完成时间<5秒

3. **可靠性指标**：

   - 数据更新成功率>99.9%
   - 异常数据自动检测率>95%
   - 链上查询成功率>99.5%

4. **用户体验**：
   - 关键收益指标展示清晰直观
   - 数据刷新不影响用户操作流畅性
   - 图表加载和交互响应及时

## 7. 开发优先级与阶段

### 7.1 第一阶段 (核心功能)

- 基础收益数据整合：实现系统内数据获取
- 简单收益率计算：总收益和基本收益率计算
- 基础Dashboard收益展示：核心指标展示
- 实时数据更新机制：基础更新流程

### 7.2 第二阶段 (增强功能)

- 多维度收益分析：详细分解收益来源
- 完整历史数据管理：建立完整历史数据存储
- 详细池子收益展示：每个池子的详细分析
- 收益图表可视化：基础图表展示功能

### 7.3 第三阶段 (优化功能)

- 高级分析指标：复杂的派生指标计算
- 预测功能：基于现有数据的简单预测
- 自定义数据视图：用户可配置的数据展示
- 高级数据可视化：交互式图表和深度分析

## 8. 计算示例

```
// 场景：用户向SOL-USDC池添加了1 SOL和28 USDC(当时价值约$58)

// 1. 初始状态(从系统交易记录获取)
初始投资 = 1 SOL($29) + 28 USDC($28) = $57
初始LP份额 = 从交易记录获取的LP代币数量

// 2. 30天后状态
当前可提取 = 通过必要的合约查询获取
  - 0.92 SOL + 32.5 USDC
  - SOL价格($32)和USDC价格($1)从系统内交易模块获取
  - 当前LP价值 = 0.92 * $32 + 32.5 * $1 = $61.94

已收取费用 = 通过合约查询计算的累计费用
  - 约0.15 SOL (约$4.8)

// 3. 收益计算
总收益 = $61.94 + $4.8 - $57 = $9.74
收益率 = $9.74 / $57 * 100% = 17.09%
年化收益率(APY) = ((1 + 0.1709) ^ (365/30) - 1) * 100% = 562.44%

// 4. 收益构成
费用收益 = $4.8 (49.28%)
价值变动收益 = $9.74 - $4.8 = $4.94 (50.72%)
```

# Agent系统-巡航模块 (精简版)

## 1. 概述

巡航模块是Agent系统的自动化持续运行引擎，负责确保Agent在用户设定的参数下持续执行投资操作。该模块监控Agent的仓位状态，在空仓时自动补充新仓位，并维持最多5个活跃仓位的限制，为用户提供"设置后遗忘"的自动化LP投资体验。

## 2. 核心功能设计

### 2.1 持续运行管理 (优先级：高)

**基础状态控制**：

- 简单的启动/停止控制机制
- 用户手动停止前持续运行
- 基本的故障自动恢复功能
- 简单的运行状态日志记录

**实现方式**：

- 基于简单状态机的控制逻辑
- 定期检查点确保系统活跃
- 仅记录关键操作和状态变化
- 最小化状态存储需求

### 2.2 仓位管理 (优先级：高)

**仓位数量控制**：

- 严格执行最大5个仓位的限制
- 实时追踪当前活跃仓位数量
- 简单的仓位记录机制
- 基本的资金可用性检查

**空位补充机制**：

- 每小时检查一次仓位数量
- 发现空仓且资金充足时自动补充
- 简单的"资金不足"状态判断
- 使用信号系统的T1池子推荐

**实现方式**：

- 基于定时触发的检查机制
- 简单的计数器跟踪仓位数量
- 直接调用交易模块API
- 最小化决策逻辑复杂度

### 2.3 与风控协调 (优先级：中)

**风控优先策略**：

- 风控操作始终具有最高优先级
- 风控执行期间暂停常规巡航操作
- 风控完成后自动恢复巡航
- 简单的冷却期机制避免频繁操作

**实现方式**：

- 基于事件的风控信号处理
- 简单的互斥锁机制
- 状态恢复后的基本检查
- 最小化协调复杂度

## 3. 用户界面集成

### 3.1 状态展示 (优先级：中)

**简化指示器**：

- 基本运行状态指示（运行/停止）
- 当前活跃仓位计数（X/5格式）
- 最近操作简要展示
- 启动/停止按钮

**实现方式**：

- 使用现有UI组件框架
- 简单的状态更新机制
- 最小化动态元素
- 使用基本文本和图标

## 4. 与其他模块的接口

### 4.1 精简接口定义

**信号系统接口**：

- 仅获取最新T1池子列表
- 简单的数据结构和调用模式
- 最小化依赖复杂度

**交易模块接口**：

- 建立新仓位的简单调用
- 基本的结果确认机制
- 最小化参数复杂度

**风控模块接口**：

- 接收简单的风控信号
- 基本的操作暂停/恢复机制
- 最小化状态同步复杂度

**Agent管理接口**：

- 获取启动/停止命令
- 报告基本运行状态
- 最小化配置参数

## 5. 技术实现考量

### 5.1 稳定性优化

**简化架构**：

- 使用同步操作模式减少并发复杂性
- 避免复杂的状态管理逻辑
- 使用简单的定时任务而非复杂调度
- 最小化依赖外部服务

**故障防护**：

- 实现基本的重试机制
- 使用简单的状态持久化
- 定期自检确保正常运行
- 出错时优先保护用户资产

**资源控制**：

- 限制操作频率减少资源消耗
- 使用简单的批处理减少API调用
- 避免复杂计算逻辑
- 简化日志减少存储需求

## 6. 验收标准

1. **基本功能**：

   - Agent启动后能持续自动运行直到用户停止
   - 严格维持最多5个活跃仓位的限制
   - 仓位移除后能在下一个检查周期发现并补充
   - 资金不足时正确暂停新建仓位

2. **可靠性**：

   - 连续运行7天无需人工干预
   - 系统重启后能正确恢复运行状态
   - 简单错误自动恢复成功率>95%

3. **效率**：
   - 系统资源使用在低水平（CPU<20%，内存<200MB）
   - 操作延迟可接受（空仓补充在1小时内）

## 7. 开发计划

### 7.1 单阶段实现

- 基础巡航状态控制（启动/停止）
- 严格的仓位数量管理
- 简单的空仓位自动补充
- 基本的资金状态检查
- 与风控模块的基本协调

## 8. 简化的执行示例

```
[2024-03-11 09:00:00] 巡航模块：Agent启动，开始运行
[2024-03-11 09:00:05] 巡航模块：检测当前活跃仓位0/5，开始建立仓位
[2024-03-11 09:00:10] 巡航模块：获取T1池子列表：SOL-USDC, JTO-USDC, BONK-SOL
[2024-03-11 09:00:15] 巡航模块：请求交易模块建立SOL-USDC仓位
[2024-03-11 09:05:30] 巡航模块：确认SOL-USDC仓位建立，当前仓位1/5
[2024-03-11 09:05:35] 巡航模块：请求交易模块建立JTO-USDC仓位
[2024-03-11 10:00:00] 巡航模块：每小时检查点，当前仓位2/5，继续补充
[2024-03-11 10:00:10] 巡航模块：请求交易模块建立BONK-SOL仓位
[2024-03-11 10:05:25] 巡航模块：确认所有仓位建立，当前仓位3/5，资金不足，等待下次检查

[2024-03-11 14:30:22] 巡航模块：接收风控信号，BONK-SOL触发风控，暂停操作
[2024-03-11 14:32:10] 巡航模块：风控完成，恢复运行，当前仓位2/5
[2024-03-11 15:00:00] 巡航模块：每小时检查点，发现空仓位，资金充足
[2024-03-11 15:00:10] 巡航模块：请求交易模块建立新仓位

[2024-03-12 08:45:15] 巡航模块：检测到用户资金注入
[2024-03-12 09:00:00] 巡航模块：每小时检查点，当前仓位3/5，资金充足
[2024-03-12 09:00:10] 巡航模块：请求交易模块建立新仓位
```

## 9. 简化状态机

**主要状态**：

1. **运行**：正常运行状态，执行定期检查和操作
2. **等待**：等待外部条件（如资金充足或风控完成）
3. **停止**：用户手动停止，不执行任何自动操作

**状态转换**：

- 运行 → 等待：资金不足或风控触发
- 等待 → 运行：条件满足（资金注入或风控完成）
- 运行/等待 → 停止：用户手动停止
- 停止 → 运行：用户手动启动

# 开发计划

### 基础准备工作（开发前）

1. **项目基础架构搭建**

   - 设置开发环境和基础代码结构
   - 建立共享组件库和公共工具函数
   - 配置Solana RPC节点连接和基础交互接口
   - 设置基础数据库结构和API框架

2. **核心工具和库的集成**

   - 集成Jupiter API和SDK
   - 集成Meteora DLMM SDK
   - 设置Web3认证和钱包连接基础组件
   - 建立基本的数据缓存和状态管理机制

3. **设计系统间通信架构**
   - 定义模块间的数据流和接口规范
   - 建立事件总线或消息机制
   - 设计统一的错误处理和日志记录机制

### 模块开发优先顺序

我建议采用以下顺序进行开发，这样可以先建立核心功能，然后逐步扩展：

**第一阶段（核心功能）：**

1. **Agent管理模块**（简化版）

   - 基础钱包连接和创建功能
   - 简单资金注入/提取功能
   - 基础Dashboard视图

2. **信号系统-数据模块**

   - 实现Meteora API连接和基础数据获取
   - 建立基本的池子筛选机制
   - 简化数据存储结构

3. **交易模块**
   - 基础Swap和LP添加功能
   - 简单的交易执行机制
   - 基本交易记录存储

**第二阶段（风控与核心增强）：**

4. **信号系统-信号模块和打分模块**

   - 实现基础风险评分算法
   - 完成池子质量评估功能
   - 建立简化的推荐输出机制

5. **监控模块**

   - 基础池子状态监控
   - 简单风险指标计算
   - 基础预警机制

6. **风控模块**
   - 风险触发识别与处理
   - 基础LP移除和资产转换功能
   - 简单状态报告机制

**第三阶段（完善与优化）：**

7. **计算模块**

   - 基础收益计算逻辑
   - 简单的历史数据分析
   - 基础数据可视化准备

8. **巡航模块**

   - 简单的自动运行机制
   - 基础仓位维护功能
   - 与风控模块的简单协调

9. **信号系统-运行模块**
   - 基础调度和定时任务
   - 简单的错误处理和恢复机制
   - 基础系统监控

### 并行开发建议

某些模块可以并行开发以提高效率：

- **前端UI组件**可以与后端模块同时开发
- **数据模块**和**Agent管理模块**可以并行开发
- **计算模块**可以在交易模块基本完成后并行开发

通过这种方式，您可以逐步构建系统，每个阶段都有可用的功能，同时确保最关键的部分（用户管理、交易执行和风险控制）得到优先处理。
