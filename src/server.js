"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const monitoring_1 = require("@liqpro/monitoring");
const dotenv_1 = __importDefault(require("dotenv"));
const express_1 = __importDefault(require("express"));
const cors_1 = __importDefault(require("cors"));
const http_1 = __importDefault(require("http"));
const api_1 = require("./routes/api");
const data_controller_1 = require("./modules/data-controller");
const mongodb_storage_1 = require("./modules/storage/mongodb-storage");
// Load environment variables
dotenv_1.default.config();
const logger = (0, monitoring_1.createLogger)('data-service:server');
// Configuration
const config = {
    port: parseInt(process.env.PORT || '3001'),
    rpcEndpoint: process.env.SOLANA_RPC_ENDPOINT || 'https://api.mainnet-beta.solana.com',
    rpcCommitment: (process.env.SOLANA_RPC_COMMITMENT || 'confirmed'),
    meteoraProgramId: process.env.METEORA_PROGRAM_ID || '675kPX9MHTjS2zt1qfr1NYHuzeLXfQM9H24wFSUt1Mp8',
    mongodb: {
        uri: process.env.MONGODB_URI || 'mongodb://localhost:27017',
        dbName: process.env.MONGODB_DB_NAME || 'liqpro_data',
    },
    collectionIntervals: {
        poolData: parseInt(process.env.POOL_DATA_INTERVAL || '60000'),
        events: parseInt(process.env.EVENTS_INTERVAL || '30000'),
        marketPrices: parseInt(process.env.MARKET_PRICES_INTERVAL || '300000'),
    },
    whaleThresholds: {
        swapUsdValue: parseInt(process.env.WHALE_SWAP_THRESHOLD || '10000'),
        depositUsdValue: parseInt(process.env.WHALE_DEPOSIT_THRESHOLD || '50000'),
        withdrawUsdValue: parseInt(process.env.WHALE_WITHDRAW_THRESHOLD || '50000'),
    },
};
// Initialize storage
const storage = new mongodb_storage_1.MongoDBStorage({
    uri: config.mongodb.uri,
    dbName: config.mongodb.dbName,
    collections: {
        poolData: 'pool_data',
        poolMetadata: 'pool_metadata',
        events: 'events',
        tokenPrices: 'token_prices',
        tokenMetadata: 'token_metadata',
        whaleActivities: 'whale_activities',
    },
    indexes: {
        enabled: true,
        ttl: {
            poolData: 60 * 60 * 24 * 30, // 30 days
            events: 60 * 60 * 24 * 90, // 90 days
            tokenPrices: 60 * 60 * 24 * 30, // 30 days
        },
    },
});
// Initialize data controller
const dataController = new data_controller_1.DataController({
    rpcEndpoint: config.rpcEndpoint,
    rpcCommitment: config.rpcCommitment,
    meteoraProgramId: config.meteoraProgramId,
    collectionIntervals: config.collectionIntervals,
    whaleThresholds: config.whaleThresholds,
    storage,
});
// Create Express app
const app = (0, express_1.default)();
// Middleware
app.use((0, cors_1.default)());
app.use(express_1.default.json());
app.use(express_1.default.urlencoded({ extended: true }));
// API routes
app.use('/api', (0, api_1.createApiRoutes)(dataController));
// Health check endpoint
app.get('/health', (req, res) => {
    res.status(200).json({ status: 'ok' });
});
// Error handler
app.use((err, req, res, next) => {
    logger.error('Unhandled error', { error: err });
    res.status(500).json({ error: 'Internal server error' });
});
// Create HTTP server
const server = http_1.default.createServer(app);
// Setup WebSocket server
const wss = (0, api_1.setupWebSocket)(server, dataController);
// Start server
async function startServer() {
    try {
        // Connect to MongoDB
        await storage.connect();
        // Start data controller
        await dataController.start();
        // Start server
        server.listen(config.port, () => {
            logger.info(`Server started on port ${config.port}`);
        });
        // Handle shutdown
        const shutdown = async () => {
            logger.info('Shutting down...');
            // Stop data controller
            dataController.stop();
            // Close WebSocket server
            wss.close();
            // Close HTTP server
            server.close();
            // Disconnect from MongoDB
            await storage.disconnect();
            logger.info('Shutdown complete');
            process.exit(0);
        };
        process.on('SIGINT', shutdown);
        process.on('SIGTERM', shutdown);
    }
    catch (error) {
        logger.error('Failed to start server', { error });
        process.exit(1);
    }
}
// Start server
startServer();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2VydmVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL3NlcnZlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztBQUFBLG1EQUFrRDtBQUNsRCxvREFBNEI7QUFDNUIsc0RBQThCO0FBQzlCLGdEQUF3QjtBQUN4QixnREFBd0I7QUFDeEIsc0NBQStEO0FBQy9ELCtEQUEyRDtBQUMzRCx1RUFBbUU7QUFHbkUsNkJBQTZCO0FBQzdCLGdCQUFNLENBQUMsTUFBTSxFQUFFLENBQUM7QUFFaEIsTUFBTSxNQUFNLEdBQUcsSUFBQSx5QkFBWSxFQUFDLHFCQUFxQixDQUFDLENBQUM7QUFFbkQsZ0JBQWdCO0FBQ2hCLE1BQU0sTUFBTSxHQUFHO0lBQ2IsSUFBSSxFQUFFLFFBQVEsQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLElBQUksSUFBSSxNQUFNLENBQUM7SUFDMUMsV0FBVyxFQUFFLE9BQU8sQ0FBQyxHQUFHLENBQUMsbUJBQW1CLElBQUkscUNBQXFDO0lBQ3JGLGFBQWEsRUFBRSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMscUJBQXFCLElBQUksV0FBVyxDQUFhO0lBQzdFLGdCQUFnQixFQUNkLE9BQU8sQ0FBQyxHQUFHLENBQUMsa0JBQWtCLElBQUksOENBQThDO0lBQ2xGLE9BQU8sRUFBRTtRQUNQLEdBQUcsRUFBRSxPQUFPLENBQUMsR0FBRyxDQUFDLFdBQVcsSUFBSSwyQkFBMkI7UUFDM0QsTUFBTSxFQUFFLE9BQU8sQ0FBQyxHQUFHLENBQUMsZUFBZSxJQUFJLGFBQWE7S0FDckQ7SUFDRCxtQkFBbUIsRUFBRTtRQUNuQixRQUFRLEVBQUUsUUFBUSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsa0JBQWtCLElBQUksT0FBTyxDQUFDO1FBQzdELE1BQU0sRUFBRSxRQUFRLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxlQUFlLElBQUksT0FBTyxDQUFDO1FBQ3hELFlBQVksRUFBRSxRQUFRLENBQUMsT0FBTyxDQUFDLEdBQUcs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QUFDO1FBQy9CLE9BQU8sQ0FBQyxFQUFFLENBQUMsU0FBUyxFQUFFLFFBQVEsQ0FBQyxDQUFDO0lBQ2xDLENBQUM7SUFBQyxPQUFPLEtBQVUsRUFBRSxDQUFDO1FBQ3BCLE1BQU0sQ0FBQyxLQUFLLENBQUMsd0JBQXdCLEVBQUUsRUFBRSxLQUFLLEVBQUUsQ0FBQyxDQUFDO1FBQ2xELE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDbEIsQ0FBQztBQUNILENBQUM7QUFFRCxlQUFlO0FBQ2YsV0FBVyxFQUFFLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBjcmVhdGVMb2dnZXIgfSBmcm9tICdAbGlxcHJvL21vbml0b3JpbmcnO1xuaW1wb3J0IGRvdGVudiBmcm9tICdkb3RlbnYnO1xuaW1wb3J0IGV4cHJlc3MgZnJvbSAnZXhwcmVzcyc7XG5pbXBvcnQgY29ycyBmcm9tICdjb3JzJztcbmltcG9ydCBodHRwIGZyb20gJ2h0dHAnO1xuaW1wb3J0IHsgY3JlYXRlQXBpUm91dGVzLCBzZXR1cFdlYlNvY2tldCB9IGZyb20gJy4vcm91dGVzL2FwaSc7XG5pbXBvcnQgeyBEYXRhQ29udHJvbGxlciB9IGZyb20gJy4vbW9kdWxlcy9kYXRhLWNvbnRyb2xsZXInO1xuaW1wb3J0IHsgTW9uZ29EQlN0b3JhZ2UgfSBmcm9tICcuL21vZHVsZXMvc3RvcmFnZS9tb25nb2RiLXN0b3JhZ2UnO1xuaW1wb3J0IHsgRmluYWxpdHkgfSBmcm9tICdAc29sYW5hL3dlYjMuanMnO1xuXG4vLyBMb2FkIGVudmlyb25tZW50IHZhcmlhYmxlc1xuZG90ZW52LmNvbmZpZygpO1xuXG5jb25zdCBsb2dnZXIgPSBjcmVhdGVMb2dnZXIoJ2RhdGEtc2VydmljZTpzZXJ2ZXInKTtcblxuLy8gQ29uZmlndXJhdGlvblxuY29uc3QgY29uZmlnID0ge1xuICBwb3J0OiBwYXJzZUludChwcm9jZXNzLmVudi5QT1JUIHx8ICczMDAxJyksXG4gIHJwY0VuZHBvaW50OiBwcm9jZXNzLmVudi5TT0xBTkFfUlBDX0VORFBPSU5UIHx8ICdodHRwczovL2FwaS5tYWlubmV0LWJldGEuc29sYW5hLmNvbScsXG4gIHJwY0NvbW1pdG1lbnQ6IChwcm9jZXNzLmVudi5TT0xBTkFfUlBDX0NPTU1JVE1FTlQgfHwgJ2NvbmZpcm1lZCcpIGFzIEZpbmFsaXR5LFxuICBtZXRlb3JhUHJvZ3JhbUlkOlxuICAgIHByb2Nlc3MuZW52Lk1FVEVPUkFfUFJPR1JBTV9JRCB8fCAnNjc1a1BYOU1IVGpTMnp0MXFmcjFOWUh1emVMWGZRTTlIMjR3RlNVdDFNcDgnLFxuICBtb25nb2RiOiB7XG4gICAgdXJpOiBwcm9jZXNzLmVudi5NT05HT0RCX1VSSSB8fCAnbW9uZ29kYjovL2xvY2FsaG9zdDoyNzAxNycsXG4gICAgZGJOYW1lOiBwcm9jZXNzLmVudi5NT05HT0RCX0RCX05BTUUgfHwgJ2xpcXByb19kYXRhJyxcbiAgfSxcbiAgY29sbGVjdGlvbkludGVydmFsczoge1xuICAgIHBvb2xEYXRhOiBwYXJzZUludChwcm9jZXNzLmVudi5QT09MX0RBVEFfSU5URVJWQUwgfHwgJzYwMDAwJyksXG4gICAgZXZlbnRzOiBwYXJzZUludChwcm9jZXNzLmVudi5FVkVOVFNfSU5URVJWQUwgfHwgJzMwMDAwJyksXG4gICAgbWFya2V0UHJpY2VzOiBwYXJzZUludChwcm9jZXNzLmVudi5NQVJLRVRfUFJJQ0VTX0lOVEVSVkFMIHx8ICczMDAwMDAnKSxcbiAgfSxcbiAgd2hhbGVUaHJlc2hvbGRzOiB7XG4gICAgc3dhcFVzZFZhbHVlOiBwYXJzZUludChwcm9jZXNzLmVudi5XSEFMRV9TV0FQX1RIUkVTSE9MRCB8fCAnMTAwMDAnKSxcbiAgICBkZXBvc2l0VXNkVmFsdWU6IHBhcnNlSW50KHByb2Nlc3MuZW52LldIQUxFX0RFUE9TSVRfVEhSRVNIT0xEIHx8ICc1MDAwMCcpLFxuICAgIHdpdGhkcmF3VXNkVmFsdWU6IHBhcnNlSW50KHByb2Nlc3MuZW52LldIQUxFX1dJVEhEUkFXX1RIUkVTSE9MRCB8fCAnNTAwMDAnKSxcbiAgfSxcbn07XG5cbi8vIEluaXRpYWxpemUgc3RvcmFnZVxuY29uc3Qgc3RvcmFnZSA9IG5ldyBNb25nb0RCU3RvcmFnZSh7XG4gIHVyaTogY29uZmlnLm1vbmdvZGIudXJpLFxuICBkYk5hbWU6IGNvbmZpZy5tb25nb2RiLmRiTmFtZSxcbiAgY29sbGVjdGlvbnM6IHtcbiAgICBwb29sRGF0YTogJ3Bvb2xfZGF0YScsXG4gICAgcG9vbE1ldGFkYXRhOiAncG9vbF9tZXRhZGF0YScsXG4gICAgZXZlbnRzOiAnZXZlbnRzJyxcbiAgICB0b2tlblByaWNlczogJ3Rva2VuX3ByaWNlcycsXG4gICAgdG9rZW5NZXRhZGF0YTogJ3Rva2VuX21ldGFkYXRhJyxcbiAgICB3aGFsZUFjdGl2aXRpZXM6ICd3aGFsZV9hY3Rpdml0aWVzJyxcbiAgfSxcbiAgaW5kZXhlczoge1xuICAgIGVuYWJsZWQ6IHRydWUsXG4gICAgdHRsOiB7XG4gICAgICBwb29sRGF0YTogNjAgKiA2MCAqIDI0ICogMzAsIC8vIDMwIGRheXNcbiAgICAgIGV2ZW50czogNjAgKiA2MCAqIDI0ICogOTAsIC8vIDkwIGRheXNcbiAgICAgIHRva2VuUHJpY2VzOiA2MCAqIDYwICogMjQgKiAzMCwgLy8gMzAgZGF5c1xuICAgIH0sXG4gIH0sXG59KTtcblxuLy8gSW5pdGlhbGl6ZSBkYXRhIGNvbnRyb2xsZXJcbmNvbnN0IGRhdGFDb250cm9sbGVyID0gbmV3IERhdGFDb250cm9sbGVyKHtcbiAgcnBjRW5kcG9pbnQ6IGNvbmZpZy5ycGNFbmRwb2ludCxcbiAgcnBjQ29tbWl0bWVudDogY29uZmlnLnJwY0NvbW1pdG1lbnQsXG4gIG1ldGVvcmFQcm9ncmFtSWQ6IGNvbmZpZy5tZXRlb3JhUHJvZ3JhbUlkLFxuICBjb2xsZWN0aW9uSW50ZXJ2YWxzOiBjb25maWcuY29sbGVjdGlvbkludGVydmFscyxcbiAgd2hhbGVUaHJlc2hvbGRzOiBjb25maWcud2hhbGVUaHJlc2hvbGRzLFxuICBzdG9yYWdlLFxufSk7XG5cbi8vIENyZWF0ZSBFeHByZXNzIGFwcFxuY29uc3QgYXBwID0gZXhwcmVzcygpO1xuXG4vLyBNaWRkbGV3YXJlXG5hcHAudXNlKGNvcnMoKSk7XG5hcHAudXNlKGV4cHJlc3MuanNvbigpKTtcbmFwcC51c2UoZXhwcmVzcy51cmxlbmNvZGVkKHsgZXh0ZW5kZWQ6IHRydWUgfSkpO1xuXG4vLyBBUEkgcm91dGVzXG5hcHAudXNlKCcvYXBpJywgY3JlYXRlQXBpUm91dGVzKGRhdGFDb250cm9sbGVyKSk7XG5cbi8vIEhlYWx0aCBjaGVjayBlbmRwb2ludFxuYXBwLmdldCgnL2hlYWx0aCcsIChyZXEsIHJlcykgPT4ge1xuICByZXMuc3RhdHVzKDIwMCkuanNvbih7IHN0YXR1czogJ29rJyB9KTtcbn0pO1xuXG4vLyBFcnJvciBoYW5kbGVyXG5hcHAudXNlKChlcnI6IEVycm9yLCByZXE6IGV4cHJlc3MuUmVxdWVzdCwgcmVzOiBleHByZXNzLlJlc3BvbnNlLCBuZXh0OiBleHByZXNzLk5leHRGdW5jdGlvbikgPT4ge1xuICBsb2dnZXIuZXJyb3IoJ1VuaGFuZGxlZCBlcnJvcicsIHsgZXJyb3I6IGVyciB9KTtcbiAgcmVzLnN0YXR1cyg1MDApLmpzb24oeyBlcnJvcjogJ0ludGVybmFsIHNlcnZlciBlcnJvcicgfSk7XG59KTtcblxuLy8gQ3JlYXRlIEhUVFAgc2VydmVyXG5jb25zdCBzZXJ2ZXIgPSBodHRwLmNyZWF0ZVNlcnZlcihhcHApO1xuXG4vLyBTZXR1cCBXZWJTb2NrZXQgc2VydmVyXG5jb25zdCB3c3MgPSBzZXR1cFdlYlNvY2tldChzZXJ2ZXIsIGRhdGFDb250cm9sbGVyKTtcblxuLy8gU3RhcnQgc2VydmVyXG5hc3luYyBmdW5jdGlvbiBzdGFydFNlcnZlcigpIHtcbiAgdHJ5IHtcbiAgICAvLyBDb25uZWN0IHRvIE1vbmdvREJcbiAgICBhd2FpdCBzdG9yYWdlLmNvbm5lY3QoKTtcblxuICAgIC8vIFN0YXJ0IGRhdGEgY29udHJvbGxlclxuICAgIGF3YWl0IGRhdGFDb250cm9sbGVyLnN0YXJ0KCk7XG5cbiAgICAvLyBTdGFydCBzZXJ2ZXJcbiAgICBzZXJ2ZXIubGlzdGVuKGNvbmZpZy5wb3J0LCAoKSA9PiB7XG4gICAgICBsb2dnZXIuaW5mbyhgU2VydmVyIHN0YXJ0ZWQgb24gcG9ydCAke2NvbmZpZy5wb3J0fWApO1xuICAgIH0pO1xuXG4gICAgLy8gSGFuZGxlIHNodXRkb3duXG4gICAgY29uc3Qgc2h1dGRvd24gPSBhc3luYyAoKSA9PiB7XG4gICAgICBsb2dnZXIuaW5mbygnU2h1dHRpbmcgZG93bi4uLicpO1xuXG4gICAgICAvLyBTdG9wIGRhdGEgY29udHJvbGxlclxuICAgICAgZGF0YUNvbnRyb2xsZXIuc3RvcCgpO1xuXG4gICAgICAvLyBDbG9zZSBXZWJTb2NrZXQgc2VydmVyXG4gICAgICB3c3MuY2xvc2UoKTtcblxuICAgICAgLy8gQ2xvc2UgSFRUUCBzZXJ2ZXJcbiAgICAgIHNlcnZlci5jbG9zZSgpO1xuXG4gICAgICAvLyBEaXNjb25uZWN0IGZyb20gTW9uZ29EQlxuICAgICAgYXdhaXQgc3RvcmFnZS5kaXNjb25uZWN0KCk7XG5cbiAgICAgIGxvZ2dlci5pbmZvKCdTaHV0ZG93biBjb21wbGV0ZScpO1xuICAgICAgcHJvY2Vzcy5leGl0KDApO1xuICAgIH07XG5cbiAgICBwcm9jZXNzLm9uKCdTSUdJTlQnLCBzaHV0ZG93bik7XG4gICAgcHJvY2Vzcy5vbignU0lHVEVSTScsIHNodXRkb3duKTtcbiAgfSBjYXRjaCAoZXJyb3I6IGFueSkge1xuICAgIGxvZ2dlci5lcnJvcignRmFpbGVkIHRvIHN0YXJ0IHNlcnZlcicsIHsgZXJyb3IgfSk7XG4gICAgcHJvY2Vzcy5leGl0KDEpO1xuICB9XG59XG5cbi8vIFN0YXJ0IHNlcnZlclxuc3RhcnRTZXJ2ZXIoKTtcbiJdfQ==