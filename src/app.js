"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const express_1 = __importDefault(require("express"));
const cors_1 = __importDefault(require("cors"));
const helmet_1 = __importDefault(require("helmet"));
const compression_1 = __importDefault(require("compression"));
const monitoring_1 = require("@liqpro/monitoring");
const api_1 = require("./routes/api");
const data_controller_1 = require("./modules/data-controller");
const mongodb_storage_1 = require("./modules/storage/mongodb-storage");
const http_1 = __importDefault(require("http"));
const dotenv_1 = __importDefault(require("dotenv"));
// Load environment variables
dotenv_1.default.config();
const logger = (0, monitoring_1.createLogger)('data-service:app');
// Configuration
const config = {
    port: parseInt(process.env.PORT || '3001'),
    rpcEndpoint: process.env.SOLANA_RPC_ENDPOINT || 'https://api.mainnet-beta.solana.com',
    rpcBackupEndpoint: process.env.SOLANA_RPC_BACKUP_ENDPOINT || 'https://soft-snowy-asphalt.solana-mainnet.quiknode.pro/48639631c6e4e81af5a0b8e228f6f9a0329154b7/',
    rpcCommitment: (process.env.SOLANA_RPC_COMMITMENT || 'confirmed'),
    meteoraProgramId: process.env.METEORA_PROGRAM_ID || '675kPX9MHTjS2zt1qfr1NYHuzeLXfQM9H24wFSUt1Mp8',
    mongodb: {
        uri: process.env.MONGODB_URI || 'mongodb://localhost:27017',
        dbName: process.env.MONGODB_DB_NAME || 'liqpro_data',
    },
    collectionIntervals: {
        poolData: parseInt(process.env.POOL_DATA_INTERVAL || '60000'),
        events: parseInt(process.env.EVENTS_INTERVAL || '30000'),
        marketPrices: parseInt(process.env.MARKET_PRICES_INTERVAL || '300000'),
    },
    whaleThresholds: {
        swapUsdValue: parseInt(process.env.WHALE_SWAP_THRESHOLD || '10000'),
        depositUsdValue: parseInt(process.env.WHALE_DEPOSIT_THRESHOLD || '50000'),
        withdrawUsdValue: parseInt(process.env.WHALE_WITHDRAW_THRESHOLD || '50000'),
    },
};
// Initialize storage
const storage = new mongodb_storage_1.MongoDBStorage({
    uri: config.mongodb.uri,
    dbName: config.mongodb.dbName,
    collections: {
        poolData: 'pool_data',
        poolMetadata: 'pool_metadata',
        events: 'events',
        tokenPrices: 'token_prices',
        tokenMetadata: 'token_metadata',
        whaleActivities: 'whale_activities',
    },
    indexes: {
        enabled: true,
        ttl: {
            poolData: 60 * 60 * 24 * 30, // 30 days
            events: 60 * 60 * 24 * 90, // 90 days
            tokenPrices: 60 * 60 * 24 * 30, // 30 days
        },
    },
});
// Initialize data controller
const dataController = new data_controller_1.DataController({
    rpcEndpoint: config.rpcEndpoint,
    rpcBackupEndpoint: config.rpcBackupEndpoint,
    rpcCommitment: config.rpcCommitment,
    meteoraProgramId: config.meteoraProgramId,
    collectionIntervals: config.collectionIntervals,
    whaleThresholds: config.whaleThresholds,
    storage,
});
// Create Express app
const app = (0, express_1.default)();
// Middleware
app.use((0, helmet_1.default)());
app.use((0, cors_1.default)());
app.use((0, compression_1.default)());
app.use(express_1.default.json());
app.use(express_1.default.urlencoded({ extended: true }));
// API routes
app.use('/api', (0, api_1.createApiRoutes)(dataController));
// Error handler
app.use((err, req, res, next) => {
    logger.error('Unhandled error', { error: err });
    res.status(500).json({ error: 'Internal server error' });
});
// Create HTTP server
const server = http_1.default.createServer(app);
// Setup WebSocket server
const wss = (0, api_1.setupWebSocket)(server, dataController);
// Start server
async function startServer() {
    try {
        // Connect to MongoDB
        await storage.connect();
        // Start data controller
        await dataController.start();
        // Start server
        server.listen(config.port, () => {
            logger.info(`Server started on port ${config.port}`);
        });
        // Handle shutdown
        const shutdown = async () => {
            logger.info('Shutting down...');
            // Stop data controller
            dataController.stop();
            // Close WebSocket server
            wss.close();
            // Close HTTP server
            server.close();
            // Disconnect from MongoDB
            await storage.disconnect();
            logger.info('Shutdown complete');
            process.exit(0);
        };
        process.on('SIGINT', shutdown);
        process.on('SIGTERM', shutdown);
    }
    catch (error) {
        logger.error('Failed to start server', { error });
        process.exit(1);
    }
}
// Start server
startServer();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXBwLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL2FwcC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztBQUFBLHNEQUE4QjtBQUM5QixnREFBd0I7QUFDeEIsb0RBQTRCO0FBQzVCLDhEQUFzQztBQUN0QyxtREFBa0Q7QUFDbEQsc0NBQStEO0FBQy9ELCtEQUEyRDtBQUMzRCx1RUFBbUU7QUFFbkUsZ0RBQXdCO0FBQ3hCLG9EQUE0QjtBQUU1Qiw2QkFBNkI7QUFDN0IsZ0JBQU0sQ0FBQyxNQUFNLEVBQUUsQ0FBQztBQUVoQixNQUFNLE1BQU0sR0FBRyxJQUFBLHlCQUFZLEVBQUMsa0JBQWtCLENBQUMsQ0FBQztBQUVoRCxnQkFBZ0I7QUFDaEIsTUFBTSxNQUFNLEdBQUc7SUFDYixJQUFJLEVBQUUsUUFBUSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsSUFBSSxJQUFJLE1BQU0sQ0FBQztJQUMxQyxXQUFXLEVBQUUsT0FBTyxDQUFDLEdBQUcsQ0FBQyxtQkFBbUIsSUFBSSxxQ0FBcUM7SUFDckYsaUJBQWlCLEVBQUUsT0FBTyxDQUFDLEdBQUcsQ0FBQywwQkFBMEIsSUFBSSxrR0FBa0c7SUFDL0osYUFBYSxFQUFFLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxxQkFBcUIsSUFBSSxXQUFXLENBQWE7SUFDN0UsZ0JBQWdCLEVBQ2QsT0FBTyxDQUFDLEdBQUcsQ0FBQyxrQkFBa0IsSUFBSSw4Q0FBOEM7SUFDbEYsT0FBTyxFQUFFO1FBQ1AsR0FBRyxFQUFFLE9BQU8sQ0FBQyxHQUFHLENBQUMsV0FBVyxJQUFJLDJCQUEyQjtRQUMzRCxNQUFNLEVBQUUsT0FBTyxDQUFDLEdBQUcsQ0FBQyxlQUFlLElBQUksYUFBYTtLQUNyRDtJQUNELG1CQUFtQixFQUFFO1FBQ25CLFFBQVEsRUFBRSxRQUFRLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxrQkFBa0IsSUFBSSxPQUFPLENBQUM7UUFDN0QsTUFBTSxFQUFFLFFBQVEsQ0FBQyxPQUFP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QyxFQUFFLENBQUMsUUFBUSxFQUFFLFFBQVEsQ0FBQyxDQUFDO1FBQy9CLE9BQU8sQ0FBQyxFQUFFLENBQUMsU0FBUyxFQUFFLFFBQVEsQ0FBQyxDQUFDO0lBQ2xDLENBQUM7SUFBQyxPQUFPLEtBQVUsRUFBRSxDQUFDO1FBQ3BCLE1BQU0sQ0FBQyxLQUFLLENBQUMsd0JBQXdCLEVBQUUsRUFBRSxLQUFLLEVBQUUsQ0FBQyxDQUFDO1FBQ2xELE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDbEIsQ0FBQztBQUNILENBQUM7QUFFRCxlQUFlO0FBQ2YsV0FBVyxFQUFFLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgZXhwcmVzcyBmcm9tICdleHByZXNzJztcbmltcG9ydCBjb3JzIGZyb20gJ2NvcnMnO1xuaW1wb3J0IGhlbG1ldCBmcm9tICdoZWxtZXQnO1xuaW1wb3J0IGNvbXByZXNzaW9uIGZyb20gJ2NvbXByZXNzaW9uJztcbmltcG9ydCB7IGNyZWF0ZUxvZ2dlciB9IGZyb20gJ0BsaXFwcm8vbW9uaXRvcmluZyc7XG5pbXBvcnQgeyBjcmVhdGVBcGlSb3V0ZXMsIHNldHVwV2ViU29ja2V0IH0gZnJvbSAnLi9yb3V0ZXMvYXBpJztcbmltcG9ydCB7IERhdGFDb250cm9sbGVyIH0gZnJvbSAnLi9tb2R1bGVzL2RhdGEtY29udHJvbGxlcic7XG5pbXBvcnQgeyBNb25nb0RCU3RvcmFnZSB9IGZyb20gJy4vbW9kdWxlcy9zdG9yYWdlL21vbmdvZGItc3RvcmFnZSc7XG5pbXBvcnQgeyBGaW5hbGl0eSB9IGZyb20gJ0Bzb2xhbmEvd2ViMy5qcyc7XG5pbXBvcnQgaHR0cCBmcm9tICdodHRwJztcbmltcG9ydCBkb3RlbnYgZnJvbSAnZG90ZW52JztcblxuLy8gTG9hZCBlbnZpcm9ubWVudCB2YXJpYWJsZXNcbmRvdGVudi5jb25maWcoKTtcblxuY29uc3QgbG9nZ2VyID0gY3JlYXRlTG9nZ2VyKCdkYXRhLXNlcnZpY2U6YXBwJyk7XG5cbi8vIENvbmZpZ3VyYXRpb25cbmNvbnN0IGNvbmZpZyA9IHtcbiAgcG9ydDogcGFyc2VJbnQocHJvY2Vzcy5lbnYuUE9SVCB8fCAnMzAwMScpLFxuICBycGNFbmRwb2ludDogcHJvY2Vzcy5lbnYuU09MQU5BX1JQQ19FTkRQT0lOVCB8fCAnaHR0cHM6Ly9hcGkubWFpbm5ldC1iZXRhLnNvbGFuYS5jb20nLFxuICBycGNCYWNrdXBFbmRwb2ludDogcHJvY2Vzcy5lbnYuU09MQU5BX1JQQ19CQUNLVVBfRU5EUE9JTlQgfHwgJ2h0dHBzOi8vc29mdC1zbm93eS1hc3BoYWx0LnNvbGFuYS1tYWlubmV0LnF1aWtub2RlLnByby80ODYzOTYzMWM2ZTRlODFhZjVhMGI4ZTIyOGY2ZjlhMDMyOTE1NGI3LycsXG4gIHJwY0NvbW1pdG1lbnQ6IChwcm9jZXNzLmVudi5TT0xBTkFfUlBDX0NPTU1JVE1FTlQgfHwgJ2NvbmZpcm1lZCcpIGFzIEZpbmFsaXR5LFxuICBtZXRlb3JhUHJvZ3JhbUlkOlxuICAgIHByb2Nlc3MuZW52Lk1FVEVPUkFfUFJPR1JBTV9JRCB8fCAnNjc1a1BYOU1IVGpTMnp0MXFmcjFOWUh1emVMWGZRTTlIMjR3RlNVdDFNcDgnLFxuICBtb25nb2RiOiB7XG4gICAgdXJpOiBwcm9jZXNzLmVudi5NT05HT0RCX1VSSSB8fCAnbW9uZ29kYjovL2xvY2FsaG9zdDoyNzAxNycsXG4gICAgZGJOYW1lOiBwcm9jZXNzLmVudi5NT05HT0RCX0RCX05BTUUgfHwgJ2xpcXByb19kYXRhJyxcbiAgfSxcbiAgY29sbGVjdGlvbkludGVydmFsczoge1xuICAgIHBvb2xEYXRhOiBwYXJzZUludChwcm9jZXNzLmVudi5QT09MX0RBVEFfSU5URVJWQUwgfHwgJzYwMDAwJyksXG4gICAgZXZlbnRzOiBwYXJzZUludChwcm9jZXNzLmVudi5FVkVOVFNfSU5URVJWQUwgfHwgJzMwMDAwJyksXG4gICAgbWFya2V0UHJpY2VzOiBwYXJzZUludChwcm9jZXNzLmVudi5NQVJLRVRfUFJJQ0VTX0lOVEVSVkFMIHx8ICczMDAwMDAnKSxcbiAgfSxcbiAgd2hhbGVUaHJlc2hvbGRzOiB7XG4gICAgc3dhcFVzZFZhbHVlOiBwYXJzZUludChwcm9jZXNzLmVudi5XSEFMRV9TV0FQX1RIUkVTSE9MRCB8fCAnMTAwMDAnKSxcbiAgICBkZXBvc2l0VXNkVmFsdWU6IHBhcnNlSW50KHByb2Nlc3MuZW52LldIQUxFX0RFUE9TSVRfVEhSRVNIT0xEIHx8ICc1MDAwMCcpLFxuICAgIHdpdGhkcmF3VXNkVmFsdWU6IHBhcnNlSW50KHByb2Nlc3MuZW52LldIQUxFX1dJVEhEUkFXX1RIUkVTSE9MRCB8fCAnNTAwMDAnKSxcbiAgfSxcbn07XG5cbi8vIEluaXRpYWxpemUgc3RvcmFnZVxuY29uc3Qgc3RvcmFnZSA9IG5ldyBNb25nb0RCU3RvcmFnZSh7XG4gIHVyaTogY29uZmlnLm1vbmdvZGIudXJpLFxuICBkYk5hbWU6IGNvbmZpZy5tb25nb2RiLmRiTmFtZSxcbiAgY29sbGVjdGlvbnM6IHtcbiAgICBwb29sRGF0YTogJ3Bvb2xfZGF0YScsXG4gICAgcG9vbE1ldGFkYXRhOiAncG9vbF9tZXRhZGF0YScsXG4gICAgZXZlbnRzOiAnZXZlbnRzJyxcbiAgICB0b2tlblByaWNlczogJ3Rva2VuX3ByaWNlcycsXG4gICAgdG9rZW5NZXRhZGF0YTogJ3Rva2VuX21ldGFkYXRhJyxcbiAgICB3aGFsZUFjdGl2aXRpZXM6ICd3aGFsZV9hY3Rpdml0aWVzJyxcbiAgfSxcbiAgaW5kZXhlczoge1xuICAgIGVuYWJsZWQ6IHRydWUsXG4gICAgdHRsOiB7XG4gICAgICBwb29sRGF0YTogNjAgKiA2MCAqIDI0ICogMzAsIC8vIDMwIGRheXNcbiAgICAgIGV2ZW50czogNjAgKiA2MCAqIDI0ICogOTAsIC8vIDkwIGRheXNcbiAgICAgIHRva2VuUHJpY2VzOiA2MCAqIDYwICogMjQgKiAzMCwgLy8gMzAgZGF5c1xuICAgIH0sXG4gIH0sXG59KTtcblxuLy8gSW5pdGlhbGl6ZSBkYXRhIGNvbnRyb2xsZXJcbmNvbnN0IGRhdGFDb250cm9sbGVyID0gbmV3IERhdGFDb250cm9sbGVyKHtcbiAgcnBjRW5kcG9pbnQ6IGNvbmZpZy5ycGNFbmRwb2ludCxcbiAgcnBjQmFja3VwRW5kcG9pbnQ6IGNvbmZpZy5ycGNCYWNrdXBFbmRwb2ludCxcbiAgcnBjQ29tbWl0bWVudDogY29uZmlnLnJwY0NvbW1pdG1lbnQsXG4gIG1ldGVvcmFQcm9ncmFtSWQ6IGNvbmZpZy5tZXRlb3JhUHJvZ3JhbUlkLFxuICBjb2xsZWN0aW9uSW50ZXJ2YWxzOiBjb25maWcuY29sbGVjdGlvbkludGVydmFscyxcbiAgd2hhbGVUaHJlc2hvbGRzOiBjb25maWcud2hhbGVUaHJlc2hvbGRzLFxuICBzdG9yYWdlLFxufSk7XG5cbi8vIENyZWF0ZSBFeHByZXNzIGFwcFxuY29uc3QgYXBwID0gZXhwcmVzcygpO1xuXG4vLyBNaWRkbGV3YXJlXG5hcHAudXNlKGhlbG1ldCgpKTtcbmFwcC51c2UoY29ycygpKTtcbmFwcC51c2UoY29tcHJlc3Npb24oKSk7XG5hcHAudXNlKGV4cHJlc3MuanNvbigpKTtcbmFwcC51c2UoZXhwcmVzcy51cmxlbmNvZGVkKHsgZXh0ZW5kZWQ6IHRydWUgfSkpO1xuXG4vLyBBUEkgcm91dGVzXG5hcHAudXNlKCcvYXBpJywgY3JlYXRlQXBpUm91dGVzKGRhdGFDb250cm9sbGVyKSk7XG5cbi8vIEVycm9yIGhhbmRsZXJcbmFwcC51c2UoKGVycjogRXJyb3IsIHJlcTogZXhwcmVzcy5SZXF1ZXN0LCByZXM6IGV4cHJlc3MuUmVzcG9uc2UsIG5leHQ6IGV4cHJlc3MuTmV4dEZ1bmN0aW9uKSA9PiB7XG4gIGxvZ2dlci5lcnJvcignVW5oYW5kbGVkIGVycm9yJywgeyBlcnJvcjogZXJyIH0pO1xuICByZXMuc3RhdHVzKDUwMCkuanNvbih7IGVycm9yOiAnSW50ZXJuYWwgc2VydmVyIGVycm9yJyB9KTtcbn0pO1xuXG4vLyBDcmVhdGUgSFRUUCBzZXJ2ZXJcbmNvbnN0IHNlcnZlciA9IGh0dHAuY3JlYXRlU2VydmVyKGFwcCk7XG5cbi8vIFNldHVwIFdlYlNvY2tldCBzZXJ2ZXJcbmNvbnN0IHdzcyA9IHNldHVwV2ViU29ja2V0KHNlcnZlciwgZGF0YUNvbnRyb2xsZXIpO1xuXG4vLyBTdGFydCBzZXJ2ZXJcbmFzeW5jIGZ1bmN0aW9uIHN0YXJ0U2VydmVyKCkge1xuICB0cnkge1xuICAgIC8vIENvbm5lY3QgdG8gTW9uZ29EQlxuICAgIGF3YWl0IChzdG9yYWdlIGFzIE1vbmdvREJTdG9yYWdlKS5jb25uZWN0KCk7XG5cbiAgICAvLyBTdGFydCBkYXRhIGNvbnRyb2xsZXJcbiAgICBhd2FpdCBkYXRhQ29udHJvbGxlci5zdGFydCgpO1xuXG4gICAgLy8gU3RhcnQgc2VydmVyXG4gICAgc2VydmVyLmxpc3Rlbihjb25maWcucG9ydCwgKCkgPT4ge1xuICAgICAgbG9nZ2VyLmluZm8oYFNlcnZlciBzdGFydGVkIG9uIHBvcnQgJHtjb25maWcucG9ydH1gKTtcbiAgICB9KTtcblxuICAgIC8vIEhhbmRsZSBzaHV0ZG93blxuICAgIGNvbnN0IHNodXRkb3duID0gYXN5bmMgKCkgPT4ge1xuICAgICAgbG9nZ2VyLmluZm8oJ1NodXR0aW5nIGRvd24uLi4nKTtcblxuICAgICAgLy8gU3RvcCBkYXRhIGNvbnRyb2xsZXJcbiAgICAgIGRhdGFDb250cm9sbGVyLnN0b3AoKTtcblxuICAgICAgLy8gQ2xvc2UgV2ViU29ja2V0IHNlcnZlclxuICAgICAgd3NzLmNsb3NlKCk7XG5cbiAgICAgIC8vIENsb3NlIEhUVFAgc2VydmVyXG4gICAgICBzZXJ2ZXIuY2xvc2UoKTtcblxuICAgICAgLy8gRGlzY29ubmVjdCBmcm9tIE1vbmdvREJcbiAgICAgIGF3YWl0IChzdG9yYWdlIGFzIE1vbmdvREJTdG9yYWdlKS5kaXNjb25uZWN0KCk7XG5cbiAgICAgIGxvZ2dlci5pbmZvKCdTaHV0ZG93biBjb21wbGV0ZScpO1xuICAgICAgcHJvY2Vzcy5leGl0KDApO1xuICAgIH07XG5cbiAgICBwcm9jZXNzLm9uKCdTSUdJTlQnLCBzaHV0ZG93bik7XG4gICAgcHJvY2Vzcy5vbignU0lHVEVSTScsIHNodXRkb3duKTtcbiAgfSBjYXRjaCAoZXJyb3I6IGFueSkge1xuICAgIGxvZ2dlci5lcnJvcignRmFpbGVkIHRvIHN0YXJ0IHNlcnZlcicsIHsgZXJyb3IgfSk7XG4gICAgcHJvY2Vzcy5leGl0KDEpO1xuICB9XG59XG5cbi8vIFN0YXJ0IHNlcnZlclxuc3RhcnRTZXJ2ZXIoKTtcbiJdfQ==