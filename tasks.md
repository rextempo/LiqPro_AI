# LiqPro 开发任务规划

## 项目技术栈确认

### 基础环境

- Solana: mainnet
- RPC节点: ✓ 已确认可用
- 前端框架: React
- 数据库: PostgreSQL
- 监控系统: Prometheus + Grafana + ELK Stack

### 集成确认

- Meteora DLMM SDK: ✓ 已获得访问权限和文档
- Jupiter API: ✓ 已获得访问密钥
- 钱包支持: 仅 Solana 原生钱包
- 交易要求: 单笔交易，延迟不超过3秒

### 安全要求

- 密钥管理:
  - 禁止明文传输/存储
  - 需要实现用户和系统级别的权限管理
  - 必须实现安全的密钥存储和传输机制

### 架构设计规范

- 部署架构：

  - 前端：React SPA，CDN/静态服务部署
  - 后端：Node.js微服务架构
  - 数据库：PostgreSQL 12.0+（推荐AWS RDS）
  - 初期：单机部署，预留扩展接口
  - 扩展：DAU>500后迁移至集群架构

- 服务组织：
  - MVP阶段：前端直接调用后端服务
  - 二期规划：引入API网关层
  - 容器化：使用Docker + Docker Compose
  - CI/CD：GitHub Actions/GitLab CI

### UI/UX规范

- 设计风格：Notion风格
- 组件库：Tailwind UI/Shadcn UI
- 数据更新频率：
  - 关键数据：30秒/次
  - 实时日志：WebSocket推送
  - 其他数据：2-5分钟/次
- 设备适配：优先PC端，特别是Mac

### 数据存储规范

- 数据分层：
  - 热数据：30天内数据
  - 冷数据：30天以上历史数据
- 分库分表：
  - MVP阶段：单库模式
  - 扩展期：用户数>10,000后按用户ID分表
- 备份策略：
  - 使用云存储（S3/Cloud Storage）
  - 跨区域备份机制

## 详细需求规范

### 状态机规范

- 基础状态：运行、等待、停止
- 扩展状态：
  - 初始化：Agent创建后资金到位但未建仓
  - 部分减仓：风险达到中等阈值触发部分减仓
  - 紧急退出：用户触发或严重风险触发全面退出
- 状态转换触发条件：
  - Running → Waiting：可用SOL低于0.1
  - Waiting → Running：余额超过1 SOL
  - Running → 部分减仓：健康评分2.0-2.5持续10分钟
  - 任何状态 → 紧急退出：健康评分低于1.5持续5分钟或用户手动触发

### 资金安全规范

- 交易限额：
  - 单笔上限：用户总资产30%或50 SOL（取小值）
  - 日交易限额：不超过总资产70%
- 多重签名：
  - MVP阶段：实现交易前确认和结果验证的双重检查
  - 预留多重签名钱包集成接口

### 监控指标规范

- 关键指标：
  - LP池子健康度变化率（>20%/小时告警）
  - 交易滑点（>预期1.5倍告警）
  - 大户LP移除（>10%或主要池子同时移除）
  - 代币价格波动（30分钟内>15%）
  - Agent操作空闲时间监控
- 告警级别：
  - 信息：UI显示
  - 警告：UI+邮件
  - 严重/紧急：UI+邮件+短信/Telegram

### 数据备份规范

- 备份频率：
  - 交易数据：实时备份
  - 配置数据：变更即备份
  - 系统状态：5分钟增量，每日全量
- 数据保留：
  - 交易记录：永久
  - 详细日志：90天
  - 系统数据：1年以上
- 跨区域备份要求：至少一个跨区域备份

### 性能指标规范

- 并发要求：
  - MVP阶段：支持500并发用户
  - 目标扩展：2000-5000用户
- 交易处理：
  - 常规：10-20 TPS
  - 峰值：能应对市场波动时的并发
- 响应时间：
  - 交易延迟：<3秒
  - UI响应：<1秒

### 错误处理规范

- 重试机制：
  - 3次重试（间隔：5s、15s、30s）
  - 每次重试可调整滑点容忍度（5%-10%）
- 网络波动处理：
  - 至少3个备用RPC节点
  - 自动节点切换机制
  - 非紧急交易自动暂停
- 手动恢复机制：
  - 交易重试功能
  - 状态回滚能力
  - 紧急操作接口

### 测试要求规范

- 环境要求：
  - 完整测试网环境
  - 主网数据回放能力
  - 模拟交易生成器
- 压测指标：
  - 200 Agent并发操作
  - 市场波动模拟
  - 7天无人值守测试

## 阶段一：基础设施搭建（2周）

### 1.1 项目初始化（3天）

- [ ] 创建项目基础结构
  ```
  /LiqPro
  ├── services/                # 微服务模块
  │   ├── data-service/       # 数据采集和处理服务
  │   ├── signal-service/     # 信号生成和分析服务
  │   ├── scoring-service/    # 评分和决策服务
  │   └── agent-engine/       # Agent执行引擎
  ├── libs/                   # 共享库
  ├── frontend/              # 前端应用
  ├── deploy/                # 部署配置
  └── docs/                  # 项目文档
  ```
- [ ] 配置开发环境
  - 设置Docker开发环境
  - 配置ESLint和Prettier
  - 设置Git工作流和提交规范
  - 配置CI/CD基础管道

### 1.2 数据层设计（4天）

- [x] PostgreSQL设计和实现

  - [x] 创建基本表结构（agents和transactions）
  - [x] 实现基本索引（用户ID、状态、健康分数等）
  - [x] 创建分区表结构
    - [x] 按时间范围分区transactions表
    - [x] 设置分区维护策略
  - [x] 设置数据备份策略
    - [x] 配置WAL归档
    - [x] 实现定时备份脚本
    - [x] 设置跨区域备份

- [x] MongoDB配置和优化

  - [x] 完成基础连接配置
  - [x] 配置分片策略
    - [x] 设置分片键（agentId）
    - [x] 配置chunk大小
  - [x] 创建索引结构
    - [x] 创建复合索引
    - [x] 设置TTL索引
  - [x] 实现数据生命周期管理
    - [x] 配置数据过期策略
    - [x] 实现数据归档流程

- [x] Redis缓存层实现
  - [x] 完成基础连接配置
  - [x] 配置内存管理策略
    - [x] 设置maxmemory策略
    - [x] 配置内存警告阈值
  - [x] 设置持久化策略
    - [x] 配置RDB快照
    - [x] 设置AOF持久化
  - [x] 实现数据过期策略
    - [x] 设置缓存TTL
    - [x] 实现LRU淘汰机制

### 1.3 安全基础设施（3天）

- [x] 实现认证系统
  - [x] JWT认证实现
  - [x] 刷新令牌机制
  - [x] API限流实现
- [x] 加密系统实现
  - [x] 密钥分片存储
  - [x] 数据加密实现
  - [x] 安全传输层配置

### 1.4 监控系统搭建（4天）

- [ ] Prometheus + Grafana设置
  - 配置系统指标采集
  - 设置业务指标监控
  - 创建告警规则
- [ ] ELK日志系统实现
  - 配置日志收集
  - 设置索引策略
  - 实现日志轮转

## 阶段二：核心服务开发（3周）

### 2.1 数据服务开发（5天）

- [ ] 实现data-service
  - Meteora池子数据采集
  - 市场数据聚合处理
  - 实时数据流管理
  - 历史数据存储优化

### 2.2 信号服务开发（5天）

- [ ] 实现signal-service
  - 市场分析模块
  - 策略生成系统
  - 信号优化处理
  - 回测系统实现

### 2.3 评分服务开发（5天）

- [ ] 实现scoring-service
  - 健康度评分系统
  - 风险评估模块
  - 收益分析系统
  - 决策建议生成

### 2.4 Agent引擎开发（6天）

- [ ] 实现agent-engine
  - Agent生命周期管理
  - 交易执行系统
  - 资金管理模块
  - 风控系统实现

## 阶段三：前端开发（2周）

### 3.1 基础框架搭建（3天）

- [ ] 前端项目初始化
  - React项目配置
  - 路由系统设置
  - 状态管理实现
  - API客户端配置

### 3.2 核心功能实现（8天）

- [ ] 实现用户界面
  - Dashboard开发
  - Agent管理界面
  - 监控页面实现
  - 设置界面开发

### 3.3 性能优化（3天）

- [ ] 前端性能优化
  - 代码分割实现
  - 缓存策略优化
  - 首屏加载优化
  - 实时数据更新优化

## 阶段四：集成测试和部署（1周）

### 4.1 集成测试（3天）

- [ ] 系统集成测试
  - 服务间集成测试
  - 端到端测试
  - 性能压力测试
  - 安全漏洞测试

### 4.2 部署配置（2天）

- [ ] 生产环境部署
  - Kubernetes配置
  - 负载均衡设置
  - SSL证书配置
  - 监控告警配置

### 4.3 文档完善（2天）

- [ ] 文档更新
  - API文档更新
  - 部署文档完善
  - 运维手册编写
  - 用户使用手册

## 里程碑和时间节点

1. 第一阶段完成（2周）：基础设施就绪

   - 开发环境可用
   - 数据库系统可用
   - 监控系统运行

2. 第二阶段完成（5周）：核心服务可用

   - 所有微服务运行
   - 服务间通信正常
   - 基本功能可用

3. 第三阶段完成（7周）：系统可用

   - 前端界面完成
   - 全部功能可用
   - 性能达标

4. 第四阶段完成（8周）：正式上线
   - 全部测试通过
   - 生产环境就绪
   - 文档完善

## 风险管理

### 技术风险

- Solana RPC节点稳定性
- 数据库性能和扩展性
- 实时数据处理延迟

### 应对策略

- 多RPC节点备份
- 数据库分片和读写分离
- 缓存优化和任务队列

## 质量保证

### 测试覆盖

- 单元测试覆盖率 > 80%
- 集成测试覆盖关键路径
- 性能测试达标

### 监控指标

- 服务可用性 > 99.9%
- API响应时间 < 1s
- 错误率 < 0.1%

## 注意事项

### 安全性

- 所有代码必须遵循严格的安全协议
- 实施多层验证机制
- 定期进行安全审计
- 确保密钥管理的安全性

### 性能

- 优化 Solana 性能要求
- 实施高效的缓存策略
- 最小化 RPC 调用
- 在可能的情况下批量操作

### 可靠性

- 实施全面的错误处理
- 创建健壮的恢复机制
- 建立详细的日志系统
- 设置自动监控和警报

### 可扩展性

- 设计支持水平扩展
- 实施适当的数据库分片
- 创建高效的缓存层
- 建立负载均衡系统

## 每日工作流程

1. 代码审查和同步（每日）
2. 进度更新和调整（每周）
3. 安全审查（每周）
4. 性能监控和优化（持续）

## 沟通机制

1. 代码变更：通过 GitHub PR
2. 问题追踪：使用 GitHub Issues
3. 文档更新：实时更新本任务文档
4. 紧急情况：建立紧急联系机制

## 实现规范详细说明

### 健康度评分系统规范

- 评分构成（100分制）：
  - 基础性能评分(40%)：
    - 交易量评分(40%)
    - 24h收益率评分(35%)
    - 流动性评分(20%)
    - 费用总量评分(5%)
  - 流动性分布评分(25%)
  - 费用效率评分(15%)
  - 稳定性评分(20%)
- 评分更新频率：固定5分钟
- 数据存储策略：
  - 5分钟粒度保存48小时
  - 每日UTC 00:00进行汇总

### Agent系统规范

- 资源限制：
  - 每用户最多5个Agent
  - 每Agent最多5个池子LP仓位
  - 每小时最多60次交易操作
  - 每分钟最多20次API请求
  - 同时最多20个进行中操作
- 数据存储：
  - 每Agent保存90天历史数据
- 资源隔离要求：
  - 独立钱包地址和资金
  - 独立存储空间
  - 独立执行队列
  - 独立风控参数

### 风控系统规范

- 风控指标权重：
  - 价格风险(35%)
  - 流动性风险(25%)
  - 流动性分布风险(20%)
  - 大额交易风险(20%)
- 触发条件：
  - 部分减仓：
    - 风险评分2.0-2.5持续10分钟
    - 单边LP风险系数>7持续15分钟
    - 大户4小时内撤出>15%流动性
  - 全部退出：
    - 风险评分≤1.5持续5分钟
    - 风险评分<2.0且单边LP风险>8持续10分钟
    - 24小时内大户撤出>30%流动性
    - 价格4小时内下跌>25%
- 日志保存：风控操作日志保存365天

### 收益计算规范

- 计算方法：
  - 日收益率 = (当日费用收入/当日平均流动性) × 100%
  - 总收益率 = (总收益/初始投资价值) × 100%
  - APY = ((1 + 总收益率)^(365/持有天数) - 1) × 100%
- 数据存储策略：
  - 实时数据：Redis，24小时，5分钟粒度
  - 短期数据：MongoDB，7天小时粒度，90天日粒度
  - 长期数据：PostgreSQL，365天日粒度，永久周粒度

### 用户权限规范

- 角色划分：
  - 普通用户：Agent管理权限
  - 只读用户：查看权限
  - 系统管理员：完全访问权限
- 日志保存要求：
  - 常规操作：90天
  - 关键操作：365天
  - 管理员操作：永久保存
